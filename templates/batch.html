{% extends "base.html" %}

{% block title %}æ‰¹é‡æ‰§è¡Œ - Dify Workflowæ‰¹é‡æ‰§è¡Œç³»ç»Ÿ{% endblock %}

{% block content %}
<div x-data="batchExecutionApp()" x-init="init()">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            <i class="fas fa-tasks me-2"></i>
            æ‰¹é‡æ‰§è¡Œ
        </h2>
        <div>
            <button class="btn btn-outline-secondary me-2" @click="refreshTasks()">
                <i class="fas fa-sync-alt me-1"></i>
                åˆ·æ–°ä»»åŠ¡
            </button>
            <button class="btn btn-primary" @click="showExecutionModal()">
                <i class="fas fa-plus me-1"></i>
                æ–°å»ºæ‰¹é‡ä»»åŠ¡
            </button>
        </div>
    </div>

    <!-- ä»»åŠ¡åˆ—è¡¨ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>
                        æ‰¹é‡ä»»åŠ¡åˆ—è¡¨
                    </h5>
                </div>
                <div class="card-body">
                    <!-- è¿‡æ»¤å™¨ -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="statusFilter" class="form-label">çŠ¶æ€ç­›é€‰</label>
                            <select id="statusFilter" class="form-select" x-model="statusFilter" @change="loadTasks()">
                                <option value="">æ‰€æœ‰çŠ¶æ€</option>
                                <option value="pending">ç­‰å¾…æ‰§è¡Œ</option>
                                <option value="running">æ‰§è¡Œä¸­</option>
                                <option value="completed">å·²å®Œæˆ</option>
                                <option value="failed">æ‰§è¡Œå¤±è´¥</option>
                                <option value="cancelled">å·²å–æ¶ˆ</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="workflowFilter" class="form-label">å·¥ä½œæµç­›é€‰</label>
                            <select id="workflowFilter" class="form-select" x-model="workflowFilter" @change="loadTasks()">
                                <option value="">æ‰€æœ‰å·¥ä½œæµ</option>
                                <template x-for="workflow in workflows" :key="workflow.id">
                                    <option :value="workflow.id" x-text="workflow.name"></option>
                                </template>
                            </select>
                        </div>
                    </div>

                    <!-- ä»»åŠ¡è¡¨æ ¼ -->
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ä»»åŠ¡åç§°</th>
                                    <th>å·¥ä½œæµ</th>
                                    <th>çŠ¶æ€</th>
                                    <th>è¿›åº¦</th>
                                    <th>æˆåŠŸ/å¤±è´¥</th>
                                    <th>åˆ›å»ºæ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="task in tasks" :key="task.id">
                                    <tr>
                                        <td>
                                            <strong x-text="task.name"></strong>
                                            <br>
                                            <small class="text-muted" x-text="task.original_filename"></small>
                                        </td>
                                        <td>
                                            <span x-text="getWorkflowName(task.workflow_id)"></span>
                                        </td>
                                        <td>
                                            <span class="badge" :class="getStatusBadgeClass(task.status)" x-text="getStatusText(task.status)"></span>
                                        </td>
                                        <td>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar" 
                                                     :style="`width: ${task.progress_percentage || 0}%`"
                                                     :class="getProgressBarClass(task.status)">
                                                    <span x-text="`${Math.round(task.progress_percentage || 0)}%`"></span>
                                                </div>
                                            </div>
                                            <small class="text-muted">
                                                <span x-text="task.total_items || 0"></span> é¡¹
                                            </small>
                                        </td>
                                        <td>
                                            <span class="text-success">
                                                <i class="fas fa-check-circle me-1"></i>
                                                <span x-text="task.completed_items || 0"></span>
                                            </span>
                                            /
                                            <span class="text-danger">
                                                <i class="fas fa-times-circle me-1"></i>
                                                <span x-text="task.failed_items || 0"></span>
                                            </span>
                                        </td>
                                        <td>
                                            <span x-text="formatDateTime(task.created_at)"></span>
                                        </td>
                                        <td style="min-width: 200px;">
                                            <div class="d-flex flex-wrap gap-1">
                                                <button class="btn btn-info btn-sm text-white" 
                                                        @click="viewTaskDetails(task)" 
                                                        title="æŸ¥çœ‹è¯¦æƒ…">
                                                    ğŸ‘ï¸ æŸ¥çœ‹è¯¦æƒ…
                                                </button>
                                                <button class="btn btn-success btn-sm" 
                                                        @click="downloadResult(task.id)" 
                                                        :disabled="task.status !== 'completed'"
                                                        title="ä¸‹è½½ç»“æœ">
                                                    ğŸ“¥ ä¸‹è½½ç»“æœ
                                                </button>
                                                <!-- æš‚åœæŒ‰é’® -->
                                                <button class="btn btn-warning btn-sm" 
                                                        @click="pauseTask(task.id)" 
                                                        x-show="task.status === 'running'"
                                                        title="æš‚åœä»»åŠ¡">
                                                    â¸ï¸ æš‚åœ
                                                </button>
                                                <!-- æ¢å¤æŒ‰é’® -->
                                                <button class="btn btn-primary btn-sm" 
                                                        @click="resumeTask(task.id)" 
                                                        x-show="task.status === 'paused'"
                                                        title="æ¢å¤ä»»åŠ¡">
                                                    â–¶ï¸ æ¢å¤
                                                </button>
                                                <!-- åœæ­¢æŒ‰é’® -->
                                                <button class="btn btn-warning btn-sm" 
                                                        @click="stopTask(task.id)" 
                                                        x-show="task.status === 'running' || task.status === 'paused'"
                                                        title="åœæ­¢ä»»åŠ¡">
                                                    â¹ï¸ åœæ­¢
                                                </button>
                                                <!-- é‡è¯•å¤±è´¥ä»»åŠ¡æŒ‰é’® -->
                                                <button class="btn btn-secondary btn-sm" 
                                                        @click="retryFailedTasks(task.id)" 
                                                        x-show="task.status === 'completed' && task.failed_items > 0"
                                                        title="é‡è¯•å¤±è´¥ä»»åŠ¡">
                                                    ğŸ”„ é‡è¯•å¤±è´¥
                                                </button>
                                                <button class="btn btn-danger btn-sm" 
                                                        @click="deleteTask(task.id)" 
                                                        :disabled="task.status === 'running' || task.status === 'paused'"
                                                        title="åˆ é™¤ä»»åŠ¡">
                                                    ğŸ—‘ï¸ åˆ é™¤ä»»åŠ¡
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </template>
                                <tr x-show="tasks.length === 0">
                                    <td colspan="7" class="text-center text-muted py-4">
                                        <i class="fas fa-inbox fa-2x mb-2"></i>
                                        <br>
                                        æš‚æ— æ‰¹é‡ä»»åŠ¡
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- åˆ†é¡µ -->
                    <nav x-show="pagination.pages > 1">
                        <ul class="pagination justify-content-center">
                            <li class="page-item" :class="{ disabled: pagination.page <= 1 }">
                                <a class="page-link" href="#" @click.prevent="loadTasks(pagination.page - 1)">ä¸Šä¸€é¡µ</a>
                            </li>
                            <template x-for="page in getPageNumbers()" :key="page">
                                <li class="page-item" :class="{ active: page === pagination.page }">
                                    <a class="page-link" href="#" @click.prevent="loadTasks(page)" x-text="page"></a>
                                </li>
                            </template>
                            <li class="page-item" :class="{ disabled: pagination.page >= pagination.pages }">
                                <a class="page-link" href="#" @click.prevent="loadTasks(pagination.page + 1)">ä¸‹ä¸€é¡µ</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- æ–°å»ºæ‰¹é‡ä»»åŠ¡æ¨¡æ€æ¡† -->
    <div class="modal fade" :class="{ show: showModal }" :style="{ display: showModal ? 'block' : 'none' }" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plus me-2"></i>
                        æ–°å»ºæ‰¹é‡ä»»åŠ¡
                    </h5>
                    <button type="button" class="btn-close" @click="hideExecutionModal()" aria-label="å…³é—­"></button>
                </div>
                <div class="modal-body">
                    <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="d-flex justify-content-between">
                                <div class="step" :class="{ active: currentStep >= 1, completed: currentStep > 1 }">
                                    <div class="step-number">1</div>
                                    <div class="step-title">é€‰æ‹©å·¥ä½œæµ</div>
                                </div>
                                <div class="step" :class="{ active: currentStep >= 2, completed: currentStep > 2 }">
                                    <div class="step-number">2</div>
                                    <div class="step-title">ä¸Šä¼ æ–‡ä»¶</div>
                                </div>
                                <div class="step" :class="{ active: currentStep >= 3, completed: currentStep > 3 }">
                                    <div class="step-number">3</div>
                                    <div class="step-title">é…ç½®æ‰§è¡Œ</div>
                                </div>
                                <div class="step" :class="{ active: currentStep >= 4 }">
                                    <div class="step-number">4</div>
                                    <div class="step-title">å¼€å§‹æ‰§è¡Œ</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ­¥éª¤1: é€‰æ‹©å·¥ä½œæµ -->
                    <div x-show="currentStep === 1">
                        <h6>é€‰æ‹©è¦æ‰§è¡Œçš„å·¥ä½œæµ</h6>
                        <div class="row">
                            <template x-for="workflow in workflows" :key="workflow.id">
                                <div class="col-md-6 mb-3">
                                    <div class="card workflow-card" 
                                         :class="{ selected: selectedWorkflow?.id === workflow.id }"
                                         @click="selectWorkflow(workflow)">
                                        <div class="card-body">
                                            <h6 class="card-title" x-text="workflow.app_name || workflow.name"></h6>
                                            <p class="card-text text-muted" x-text="workflow.app_description || workflow.description || 'æ— æè¿°'"></p>
                                            <small class="text-muted">
                                                <i class="fas fa-tag me-1"></i>
                                                <span x-text="workflow.name"></span>
                                                <span class="ms-2">
                                                    <i class="fas fa-link me-1"></i>
                                                    <span x-text="workflow.base_url"></span>
                                                </span>
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <div x-show="workflows.length === 0" class="text-center text-muted py-4">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                            <br>
                            æš‚æ— å¯ç”¨å·¥ä½œæµï¼Œè¯·å…ˆæ·»åŠ å·¥ä½œæµé…ç½®
                        </div>
                    </div>

                    <!-- æ­¥éª¤2: ä¸Šä¼ æ–‡ä»¶ -->
                    <div x-show="currentStep === 2">
                        <h6>ä¸Šä¼ Excelæ–‡ä»¶</h6>
                        <div class="mb-3">
                            <button class="btn btn-outline-primary me-2" @click="downloadTemplate()" :disabled="!selectedWorkflow">
                                <i class="fas fa-download me-1"></i>
                                ä¸‹è½½Excelæ¨¡æ¿
                            </button>
                            <small class="text-muted">å»ºè®®å…ˆä¸‹è½½æ¨¡æ¿ï¼ŒæŒ‰æ ¼å¼å¡«å†™æ•°æ®åä¸Šä¼ </small>
                        </div>
                        
                        <div class="upload-area" 
                             @dragover.prevent 
                             @drop.prevent="handleFileDrop($event)"
                             :class="{ 'drag-over': isDragOver }"
                             @dragenter="isDragOver = true"
                             @dragleave="isDragOver = false">
                                                         <input type="file" 
                                    id="fileInput" 
                                    accept=".xlsx,.xls" 
                                    @change="handleFileSelect($event)"
                                    style="display: none;"
                                    aria-label="é€‰æ‹©Excelæ–‡ä»¶">
                             <div class="text-center py-4">
                                 <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                 <h6>æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</h6>
                                 <p class="text-muted">æ”¯æŒ .xlsx å’Œ .xls æ ¼å¼</p>
                                 <button class="btn btn-outline-primary" @click="document.getElementById('fileInput').click()" aria-label="é€‰æ‹©æ–‡ä»¶">
                                     é€‰æ‹©æ–‡ä»¶
                                 </button>
                             </div>
                        </div>

                        <div x-show="selectedFile" class="mt-3">
                            <div class="alert alert-info">
                                <i class="fas fa-file-excel me-2"></i>
                                å·²é€‰æ‹©æ–‡ä»¶: <strong x-text="selectedFile?.name"></strong>
                                <span class="ms-2 text-muted" x-text="formatFileSize(selectedFile?.size)"></span>
                            </div>
                        </div>

                        <div x-show="uploadProgress > 0 && uploadProgress < 100" class="mt-3">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     :style="`width: ${uploadProgress}%`">
                                    <span x-text="`${uploadProgress}%`"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ­¥éª¤3: é…ç½®æ‰§è¡Œ -->
                    <div x-show="currentStep === 3">
                        <h6>æ‰§è¡Œé…ç½®</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">ä»»åŠ¡åç§°</label>
                                <input type="text" class="form-control" x-model="executionConfig.taskName" placeholder="è¾“å…¥ä»»åŠ¡åç§°">
                            </div>
                                                         <div class="col-md-6">
                                 <label for="maxConcurrency" class="form-label">æœ€å¤§å¹¶å‘æ•°</label>
                                 <select id="maxConcurrency" class="form-select" x-model="executionConfig.maxConcurrency">
                                     <option value="1">1 (ä¸²è¡Œæ‰§è¡Œ)</option>
                                     <option value="2">2</option>
                                     <option value="3">3 (æ¨è)</option>
                                     <option value="5">5</option>
                                     <option value="10">10</option>
                                 </select>
                             </div>
                         </div>
                         <div class="row mt-3">
                             <div class="col-md-6">
                                 <label for="retryCount" class="form-label">é‡è¯•æ¬¡æ•°</label>
                                 <select id="retryCount" class="form-select" x-model="executionConfig.retryCount">
                                     <option value="0">0 (ä¸é‡è¯•)</option>
                                     <option value="1">1</option>
                                     <option value="2">2 (æ¨è)</option>
                                     <option value="3">3</option>
                                     <option value="5">5</option>
                                 </select>
                             </div>
                             <div class="col-md-6">
                                 <label for="timeoutSeconds" class="form-label">è¶…æ—¶æ—¶é—´ (ç§’)</label>
                                 <select id="timeoutSeconds" class="form-select" x-model="executionConfig.timeoutSeconds">
                                     <option value="60">60</option>
                                     <option value="120">120</option>
                                     <option value="300">300 (æ¨è)</option>
                                     <option value="600">600</option>
                                     <option value="1200">1200</option>
                                 </select>
                             </div>
                        </div>
                    </div>

                    <!-- æ­¥éª¤4: ç¡®è®¤æ‰§è¡Œ -->
                    <div x-show="currentStep === 4">
                        <h6>ç¡®è®¤æ‰§è¡Œä¿¡æ¯</h6>
                        <div class="card">
                            <div class="card-body">
                                <dl class="row">
                                    <dt class="col-sm-3">åº”ç”¨:</dt>
                                    <dd class="col-sm-9" x-text="selectedWorkflow?.app_name || selectedWorkflow?.name"></dd>
                                    
                                    <dt class="col-sm-3">æ–‡ä»¶:</dt>
                                    <dd class="col-sm-9" x-text="selectedFile?.name"></dd>
                                    
                                    <dt class="col-sm-3">ä»»åŠ¡åç§°:</dt>
                                    <dd class="col-sm-9" x-text="executionConfig.taskName"></dd>
                                    
                                    <dt class="col-sm-3">å¹¶å‘æ•°:</dt>
                                    <dd class="col-sm-9" x-text="executionConfig.maxConcurrency"></dd>
                                    
                                    <dt class="col-sm-3">é‡è¯•æ¬¡æ•°:</dt>
                                    <dd class="col-sm-9" x-text="executionConfig.retryCount"></dd>
                                    
                                    <dt class="col-sm-3">è¶…æ—¶æ—¶é—´:</dt>
                                    <dd class="col-sm-9" x-text="`${executionConfig.timeoutSeconds} ç§’`"></dd>
                                </dl>
                            </div>
                        </div>
                    </div>

                    <!-- é”™è¯¯æç¤º -->
                    <div x-show="error" class="alert alert-danger mt-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span x-text="error"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @click="hideExecutionModal()">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-outline-secondary" @click="previousStep()" x-show="currentStep > 1">ä¸Šä¸€æ­¥</button>
                    <button type="button" class="btn btn-primary" @click="nextStep()" x-show="currentStep < 4" :disabled="!canProceedToNextStep()">ä¸‹ä¸€æ­¥</button>
                    <button type="button" class="btn btn-success" @click="startExecution()" x-show="currentStep === 4" :disabled="processing">
                        <span x-show="processing">
                            <i class="fas fa-spinner fa-spin me-1"></i>
                            æ‰§è¡Œä¸­...
                        </span>
                        <span x-show="!processing">
                            <i class="fas fa-play me-1"></i>
                            å¼€å§‹æ‰§è¡Œ
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ä»»åŠ¡è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="modal fade" :class="{ show: showDetailsModal }" :style="{ display: showDetailsModal ? 'block' : 'none' }" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-info-circle me-2"></i>
                        ä»»åŠ¡è¯¦æƒ…
                    </h5>
                                         <button type="button" class="btn-close" @click="hideDetailsModal()" aria-label="å…³é—­"></button>
                </div>
                <div class="modal-body" x-show="selectedTask">
                    <!-- ä»»åŠ¡åŸºæœ¬ä¿¡æ¯ -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6>åŸºæœ¬ä¿¡æ¯</h6>
                            <dl class="row">
                                <dt class="col-sm-4">ä»»åŠ¡åç§°:</dt>
                                <dd class="col-sm-8" x-text="selectedTask?.name"></dd>
                                <dt class="col-sm-4">çŠ¶æ€:</dt>
                                <dd class="col-sm-8">
                                    <span class="badge" :class="getStatusBadgeClass(selectedTask?.status)" x-text="getStatusText(selectedTask?.status)"></span>
                                </dd>
                                <dt class="col-sm-4">å·¥ä½œæµ:</dt>
                                <dd class="col-sm-8" x-text="getWorkflowName(selectedTask?.workflow_id)"></dd>
                            </dl>
                        </div>
                        <div class="col-md-6">
                            <h6>æ‰§è¡Œç»Ÿè®¡</h6>
                            <dl class="row">
                                <dt class="col-sm-4">æ€»é¡¹ç›®æ•°:</dt>
                                <dd class="col-sm-8" x-text="selectedTask?.total_items || 0"></dd>
                                <dt class="col-sm-4">å·²å®Œæˆ:</dt>
                                <dd class="col-sm-8 text-success" x-text="selectedTask?.completed_items || 0"></dd>
                                <dt class="col-sm-4">å¤±è´¥:</dt>
                                <dd class="col-sm-8 text-danger" x-text="selectedTask?.failed_items || 0"></dd>
                                <dt class="col-sm-4">æˆåŠŸç‡:</dt>
                                <dd class="col-sm-8" x-text="`${Math.round(selectedTask?.success_rate || 0)}%`"></dd>
                            </dl>
                        </div>
                    </div>

                    <!-- è¿›åº¦æ¡ -->
                    <div class="mb-4">
                        <h6>æ‰§è¡Œè¿›åº¦</h6>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar" 
                                 :style="`width: ${selectedTask?.progress_percentage || 0}%`"
                                 :class="getProgressBarClass(selectedTask?.status)">
                                <span x-text="`${Math.round(selectedTask?.progress_percentage || 0)}%`"></span>
                            </div>
                        </div>
                    </div>

                    <!-- æ—¶é—´ä¿¡æ¯ -->
                    <div class="mb-4">
                        <h6>æ—¶é—´ä¿¡æ¯</h6>
                        <dl class="row">
                            <dt class="col-sm-2">åˆ›å»ºæ—¶é—´:</dt>
                            <dd class="col-sm-4" x-text="formatDateTime(selectedTask?.created_at)"></dd>
                            <dt class="col-sm-2">å¼€å§‹æ—¶é—´:</dt>
                            <dd class="col-sm-4" x-text="formatDateTime(selectedTask?.started_at)"></dd>
                            <dt class="col-sm-2">å®Œæˆæ—¶é—´:</dt>
                            <dd class="col-sm-4" x-text="formatDateTime(selectedTask?.completed_at)"></dd>
                            <dt class="col-sm-2">æ‰§è¡Œæ—¶é•¿:</dt>
                            <dd class="col-sm-4" x-text="formatDuration(selectedTask?.duration_seconds)"></dd>
                        </dl>
                    </div>

                    <!-- é”™è¯¯ä¿¡æ¯ -->
                    <div x-show="selectedTask?.error_message" class="mb-4">
                        <h6>é”™è¯¯ä¿¡æ¯</h6>
                        <div class="alert alert-danger">
                            <span x-text="selectedTask?.error_message"></span>
                        </div>
                    </div>

                    <!-- å¤±è´¥ä»»åŠ¡åˆ—è¡¨ -->
                    <div x-show="selectedTask?.failed_items > 0" class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">
                                <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                                å¤±è´¥ä»»åŠ¡åˆ—è¡¨ (<span x-text="selectedTask?.failed_items || 0"></span>)
                            </h6>
                            <button class="btn btn-outline-primary btn-sm" 
                                    @click="retryAllFailedTasks(selectedTask.id)"
                                    :disabled="retryingAll">
                                <span x-show="!retryingAll">ğŸ”„ é‡è¯•æ‰€æœ‰å¤±è´¥ä»»åŠ¡</span>
                                <span x-show="retryingAll">â³ é‡è¯•ä¸­...</span>
                            </button>
                        </div>
                        
                        <div x-show="!failedExecutions.length" class="text-center py-3">
                            <button class="btn btn-outline-secondary btn-sm" 
                                    @click="loadFailedExecutions(selectedTask.id)"
                                    :disabled="loadingFailed">
                                <span x-show="!loadingFailed">ğŸ“‹ åŠ è½½å¤±è´¥ä»»åŠ¡è¯¦æƒ…</span>
                                <span x-show="loadingFailed">â³ åŠ è½½ä¸­...</span>
                            </button>
                        </div>
                        
                        <div x-show="failedExecutions.length" class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-striped">
                                <thead class="table-dark sticky-top">
                                    <tr>
                                        <th>è¡Œå·</th>
                                        <th>è¾“å…¥æ•°æ®</th>
                                        <th>é”™è¯¯ä¿¡æ¯</th>
                                        <th>é‡è¯•æ¬¡æ•°</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="execution in failedExecutions" :key="execution.id">
                                        <tr>
                                            <td x-text="execution.row_index + 1"></td>
                                            <td>
                                                <small x-text="JSON.stringify(execution.inputs).substring(0, 50) + '...'"></small>
                                            </td>
                                            <td>
                                                <small class="text-danger" x-text="execution.error_message?.substring(0, 100) + '...'"></small>
                                            </td>
                                            <td x-text="execution.retry_count || 0"></td>
                                            <td>
                                                <button class="btn btn-outline-primary btn-xs" 
                                                        @click="retrySingleExecution(selectedTask.id, execution.id)"
                                                        :disabled="execution.retrying"
                                                        title="é‡è¯•æ­¤ä»»åŠ¡">
                                                    <span x-show="!execution.retrying">ğŸ”„</span>
                                                    <span x-show="execution.retrying">â³</span>
                                                </button>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @click="hideDetailsModal()">å…³é—­</button>
                    <button type="button" class="btn btn-success" 
                            @click="downloadResult(selectedTask?.id)" 
                            :disabled="selectedTask?.status !== 'completed'">
                        <i class="fas fa-download me-1"></i>
                        ä¸‹è½½ç»“æœ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ€æ¡†èƒŒæ™¯ -->
    <div class="modal-backdrop fade" :class="{ show: showModal || showDetailsModal }" x-show="showModal || showDetailsModal"></div>
</div>

<style>
.step {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    flex: 1;
}

.step:not(:last-child)::after {
    content: '';
    position: absolute;
    top: 15px;
    left: 60%;
    right: -40%;
    height: 2px;
    background-color: #dee2e6;
    z-index: 1;
}

.step.completed:not(:last-child)::after {
    background-color: #198754;
}

.step-number {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background-color: #dee2e6;
    color: #6c757d;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-bottom: 8px;
    position: relative;
    z-index: 2;
}

.step.active .step-number {
    background-color: #0d6efd;
    color: white;
}

.step.completed .step-number {
    background-color: #198754;
    color: white;
}

.step-title {
    font-size: 12px;
    text-align: center;
    color: #6c757d;
}

.step.active .step-title {
    color: #0d6efd;
    font-weight: bold;
}

.step.completed .step-title {
    color: #198754;
}

.workflow-card {
    cursor: pointer;
    transition: all 0.2s;
    border: 2px solid transparent;
}

.workflow-card:hover {
    border-color: #0d6efd;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.workflow-card.selected {
    border-color: #0d6efd;
    background-color: #f8f9ff;
}

.upload-area {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    transition: all 0.2s;
    cursor: pointer;
}

.upload-area:hover,
.upload-area.drag-over {
    border-color: #0d6efd;
    background-color: #f8f9ff;
}

/* ä¿®å¤æŒ‰é’®ç»„æ˜¾ç¤º */
.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    line-height: 1.5;
    border-radius: 0.2rem;
}

.btn-group .btn:not(:last-child) {
    border-top-right-radius: 0;
    border-bottom-right-radius: 0;
}

.btn-group .btn:not(:first-child) {
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
    margin-left: -1px;
}

/* ç¡®ä¿è¿›åº¦æ¡æ­£ç¡®æ˜¾ç¤º */
.progress {
    height: 1.5rem;
    font-size: 0.75rem;
    background-color: #e9ecef;
    border-radius: 0.375rem;
}

.progress-bar {
    display: flex;
    flex-direction: column;
    justify-content: center;
    overflow: hidden;
    color: #fff;
    text-align: center;
    white-space: nowrap;
    background-color: #0d6efd;
    transition: width 0.6s ease;
}

/* è¡¨æ ¼å•å…ƒæ ¼å¯¹é½ */
.table td {
    vertical-align: middle;
}

/* æ“ä½œåˆ—å›ºå®šå®½åº¦ */
.table th:last-child,
.table td:last-child {
    width: 160px;
    min-width: 160px;
}
</style>

<script>
function batchExecutionApp() {
    return {
        // æ•°æ®çŠ¶æ€
        tasks: [],
        workflows: [],
        pagination: {
            page: 1,
            size: 10,
            total: 0,
            pages: 0
        },
        
        // è¿‡æ»¤å™¨
        statusFilter: '',
        workflowFilter: '',
        
        // æ¨¡æ€æ¡†çŠ¶æ€
        showModal: false,
        showDetailsModal: false,
        currentStep: 1,
        
        // é€‰æ‹©çš„æ•°æ®
        selectedWorkflow: null,
        selectedFile: null,
        selectedTask: null,
        failedExecutions: [],
        loadingFailed: false,
        retryingAll: false,
        
        // æ‰§è¡Œé…ç½®
        executionConfig: {
            taskName: '',
            maxConcurrency: 3,
            retryCount: 2,
            timeoutSeconds: 300
        },
        
        // UIçŠ¶æ€
        processing: false,
        error: '',
        uploadProgress: 0,
        isDragOver: false,
        
        // åˆå§‹åŒ–
        async init() {
            await this.loadWorkflows();
            await this.loadTasks();
            this.startAutoRefresh();
        },
        
        // åŠ è½½å·¥ä½œæµåˆ—è¡¨
        async loadWorkflows() {
            try {
                const response = await fetch('/api/workflows/');
                const data = await response.json();
                // APIç›´æ¥è¿”å›å·¥ä½œæµæ•°ç»„ï¼Œä¸æ˜¯åŒ…è£…åœ¨workflowså­—æ®µä¸­
                this.workflows = Array.isArray(data) ? data : (data.workflows || []);
            } catch (error) {
                console.error('åŠ è½½å·¥ä½œæµå¤±è´¥:', error);
            }
        },
        
        // åŠ è½½ä»»åŠ¡åˆ—è¡¨
        async loadTasks(page = 1) {
            try {
                const params = new URLSearchParams({
                    page: page,
                    size: this.pagination.size
                });
                
                if (this.statusFilter) params.append('status', this.statusFilter);
                if (this.workflowFilter) params.append('workflow_id', this.workflowFilter);
                
                const response = await fetch(`/api/batch/?${params}`);
                const data = await response.json();
                
                this.tasks = data.tasks || [];
                this.pagination = {
                    page: data.page || 1,
                    size: data.size || 10,
                    total: data.total || 0,
                    pages: data.pages || 0
                };
            } catch (error) {
                console.error('åŠ è½½ä»»åŠ¡åˆ—è¡¨å¤±è´¥:', error);
            }
        },
        
        // åˆ·æ–°ä»»åŠ¡
        async refreshTasks() {
            await this.loadTasks(this.pagination.page);
        },
        
        // è‡ªåŠ¨åˆ·æ–°
        startAutoRefresh() {
            setInterval(() => {
                if (!this.showModal && !this.showDetailsModal) {
                    this.refreshTasks();
                }
            }, 5000); // æ¯5ç§’åˆ·æ–°ä¸€æ¬¡
        },
        
        // æ˜¾ç¤ºæ‰§è¡Œæ¨¡æ€æ¡†
        showExecutionModal() {
            this.showModal = true;
            this.currentStep = 1;
            this.selectedWorkflow = null;
            this.selectedFile = null;
            this.executionConfig.taskName = '';
            this.error = '';
        },
        
        // éšè—æ‰§è¡Œæ¨¡æ€æ¡†
        hideExecutionModal() {
            this.showModal = false;
            this.currentStep = 1;
            this.selectedWorkflow = null;
            this.selectedFile = null;
            this.error = '';
            this.uploadProgress = 0;
        },
        
        // é€‰æ‹©å·¥ä½œæµ
        selectWorkflow(workflow) {
            this.selectedWorkflow = workflow;
            this.executionConfig.taskName = `${workflow.app_name || workflow.name} - æ‰¹é‡ä»»åŠ¡`;
        },
        
        // ä¸‹è½½æ¨¡æ¿
        async downloadTemplate() {
            if (!this.selectedWorkflow) return;
            
            try {
                const response = await fetch(`/api/workflows/${this.selectedWorkflow.id}/template`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${this.selectedWorkflow.name}_æ¨¡æ¿.xlsx`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                } else {
                    this.error = 'ä¸‹è½½æ¨¡æ¿å¤±è´¥';
                }
            } catch (error) {
                this.error = 'ä¸‹è½½æ¨¡æ¿å¤±è´¥: ' + error.message;
            }
        },
        
        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                this.selectedFile = file;
            }
        },
        
        // å¤„ç†æ–‡ä»¶æ‹–æ‹½
        handleFileDrop(event) {
            this.isDragOver = false;
            const file = event.dataTransfer.files[0];
            if (file && (file.name.endsWith('.xlsx') || file.name.endsWith('.xls'))) {
                this.selectedFile = file;
            }
        },
        
        // ä¸‹ä¸€æ­¥
        nextStep() {
            if (this.canProceedToNextStep()) {
                this.currentStep++;
                this.error = '';
            }
        },
        
        // ä¸Šä¸€æ­¥
        previousStep() {
            if (this.currentStep > 1) {
                this.currentStep--;
                this.error = '';
            }
        },
        
        // æ£€æŸ¥æ˜¯å¦å¯ä»¥è¿›å…¥ä¸‹ä¸€æ­¥
        canProceedToNextStep() {
            switch (this.currentStep) {
                case 1:
                    return this.selectedWorkflow !== null;
                case 2:
                    return this.selectedFile !== null;
                case 3:
                    return this.executionConfig.taskName.trim() !== '';
                default:
                    return false;
            }
        },
        
        // å¼€å§‹æ‰§è¡Œ
        async startExecution() {
            if (!this.selectedWorkflow || !this.selectedFile) return;
            
            this.processing = true;
            this.error = '';
            
            try {
                // 1. ä¸Šä¼ æ–‡ä»¶
                const formData = new FormData();
                formData.append('file', this.selectedFile);
                formData.append('workflow_id', this.selectedWorkflow.id);
                
                const uploadResponse = await fetch('/api/batch/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const uploadData = await uploadResponse.json();
                
                if (!uploadResponse.ok) {
                    throw new Error(uploadData.detail?.message || uploadData.detail || 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥');
                }
                
                // 2. å¯åŠ¨æ‰¹é‡æ‰§è¡Œ
                const executeFormData = new FormData();
                executeFormData.append('file_id', uploadData.file_id);
                executeFormData.append('workflow_id', this.selectedWorkflow.id);
                executeFormData.append('task_name', this.executionConfig.taskName);
                executeFormData.append('max_concurrency', this.executionConfig.maxConcurrency);
                executeFormData.append('retry_count', this.executionConfig.retryCount);
                executeFormData.append('timeout_seconds', this.executionConfig.timeoutSeconds);
                
                const executeResponse = await fetch('/api/batch/execute', {
                    method: 'POST',
                    body: executeFormData
                });
                
                const executeData = await executeResponse.json();
                
                if (!executeResponse.ok) {
                    throw new Error(executeData.detail?.message || executeData.detail || 'å¯åŠ¨æ‰§è¡Œå¤±è´¥');
                }
                
                // æˆåŠŸ
                this.hideExecutionModal();
                await this.loadTasks();
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                this.showSuccessMessage('æ‰¹é‡ä»»åŠ¡å·²å¯åŠ¨ï¼Œæ­£åœ¨æ‰§è¡Œä¸­...');
                
            } catch (error) {
                this.error = error.message;
            } finally {
                this.processing = false;
            }
        },
        
        // æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…
        async viewTaskDetails(task) {
            try {
                const response = await fetch(`/api/batch/${task.id}/status`);
                const data = await response.json();
                this.selectedTask = data;
                this.showDetailsModal = true;
            } catch (error) {
                console.error('è·å–ä»»åŠ¡è¯¦æƒ…å¤±è´¥:', error);
            }
        },
        
        // éšè—è¯¦æƒ…æ¨¡æ€æ¡†
        hideDetailsModal() {
            this.showDetailsModal = false;
            this.selectedTask = null;
            this.failedExecutions = [];
        },
        
        // ä¸‹è½½ç»“æœ
        async downloadResult(taskId) {
            try {
                const response = await fetch(`/api/batch/${taskId}/download`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `batch_result_${taskId}.xlsx`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                } else {
                    alert('ä¸‹è½½å¤±è´¥');
                }
            } catch (error) {
                alert('ä¸‹è½½å¤±è´¥: ' + error.message);
            }
        },
        
        // æš‚åœä»»åŠ¡
        async pauseTask(taskId) {
            if (!confirm('ç¡®å®šè¦æš‚åœè¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`/api/batch/${taskId}/pause`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    await this.loadTasks();
                    this.showSuccessMessage(result.message || 'ä»»åŠ¡å·²æš‚åœ');
                } else {
                    const error = await response.json();
                    alert(`æš‚åœä»»åŠ¡å¤±è´¥: ${error.detail || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                console.error('æš‚åœä»»åŠ¡å¤±è´¥:', error);
                alert('æš‚åœä»»åŠ¡å¤±è´¥: ' + error.message);
            }
        },
        
        // æ¢å¤ä»»åŠ¡
        async resumeTask(taskId) {
            if (!confirm('ç¡®å®šè¦æ¢å¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`/api/batch/${taskId}/resume`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    await this.loadTasks();
                    this.showSuccessMessage(result.message || 'ä»»åŠ¡å·²æ¢å¤');
                } else {
                    const error = await response.json();
                    alert(`æ¢å¤ä»»åŠ¡å¤±è´¥: ${error.detail || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                console.error('æ¢å¤ä»»åŠ¡å¤±è´¥:', error);
                alert('æ¢å¤ä»»åŠ¡å¤±è´¥: ' + error.message);
            }
        },
        
        // åœæ­¢ä»»åŠ¡
        async stopTask(taskId) {
            if (!confirm('ç¡®å®šè¦åœæ­¢è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`/api/batch/${taskId}/stop`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    await this.loadTasks();
                    this.showSuccessMessage(result.message || 'ä»»åŠ¡å·²åœæ­¢');
                } else {
                    const error = await response.json();
                    alert(`åœæ­¢ä»»åŠ¡å¤±è´¥: ${error.detail || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                console.error('åœæ­¢ä»»åŠ¡å¤±è´¥:', error);
                alert('åœæ­¢ä»»åŠ¡å¤±è´¥: ' + error.message);
            }
        },
        
        // åˆ é™¤ä»»åŠ¡
        async deleteTask(taskId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;
            
            try {
                const response = await fetch(`/api/batch/${taskId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    await this.loadTasks();
                    this.showSuccessMessage(result.message || 'ä»»åŠ¡å·²åˆ é™¤');
                } else {
                    const error = await response.json();
                    alert(`åˆ é™¤ä»»åŠ¡å¤±è´¥: ${error.detail || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                console.error('åˆ é™¤ä»»åŠ¡å¤±è´¥:', error);
                alert('åˆ é™¤ä»»åŠ¡å¤±è´¥: ' + error.message);
            }
        },
        
        // å·¥å…·æ–¹æ³•
        getWorkflowName(workflowId) {
            const workflow = this.workflows.find(w => w.id === workflowId);
            return workflow ? workflow.name : 'æœªçŸ¥å·¥ä½œæµ';
        },
        
        getStatusText(status) {
            const statusMap = {
                'pending': 'ç­‰å¾…æ‰§è¡Œ',
                'running': 'æ‰§è¡Œä¸­',
                'paused': 'å·²æš‚åœ',
                'completed': 'å·²å®Œæˆ',
                'failed': 'æ‰§è¡Œå¤±è´¥',
                'cancelled': 'å·²å–æ¶ˆ'
            };
            return statusMap[status] || status;
        },
        
        getStatusBadgeClass(status) {
            const classMap = {
                'pending': 'bg-secondary',
                'running': 'bg-primary',
                'paused': 'bg-warning',
                'completed': 'bg-success',
                'failed': 'bg-danger',
                'cancelled': 'bg-warning'
            };
            return classMap[status] || 'bg-secondary';
        },
        
        getProgressBarClass(status) {
            const classMap = {
                'running': 'progress-bar-striped progress-bar-animated',
                'completed': 'bg-success',
                'failed': 'bg-danger',
                'cancelled': 'bg-warning'
            };
            return classMap[status] || '';
        },
        
        formatDateTime(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleString('zh-CN');
        },
        
        formatDuration(seconds) {
            if (!seconds) return '-';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours}å°æ—¶${minutes}åˆ†é’Ÿ${secs}ç§’`;
            } else if (minutes > 0) {
                return `${minutes}åˆ†é’Ÿ${secs}ç§’`;
            } else {
                return `${secs}ç§’`;
            }
        },

        // åŠ è½½å¤±è´¥çš„æ‰§è¡Œè®°å½•
        async loadFailedExecutions(batchId) {
            this.loadingFailed = true;
            try {
                const response = await fetch(`/api/batch/${batchId}/failed-executions`);
                const data = await response.json();
                
                if (response.ok) {
                    this.failedExecutions = data.failed_executions || [];
                } else {
                    this.error = data.detail || 'åŠ è½½å¤±è´¥ä»»åŠ¡å¤±è´¥';
                }
            } catch (error) {
                console.error('åŠ è½½å¤±è´¥ä»»åŠ¡å¤±è´¥:', error);
                this.error = 'åŠ è½½å¤±è´¥ä»»åŠ¡å¤±è´¥: ' + error.message;
            } finally {
                this.loadingFailed = false;
            }
        },

        // é‡è¯•å•ä¸ªå¤±è´¥çš„æ‰§è¡Œä»»åŠ¡
        async retrySingleExecution(batchId, executionId) {
            // è®¾ç½®é‡è¯•çŠ¶æ€
            const execution = this.failedExecutions.find(e => e.id === executionId);
            if (execution) {
                execution.retrying = true;
            }

            try {
                const response = await fetch(`/api/batch/${batchId}/executions/${executionId}/retry`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (response.ok) {
                    // ä»å¤±è´¥åˆ—è¡¨ä¸­ç§»é™¤è¯¥ä»»åŠ¡
                    this.failedExecutions = this.failedExecutions.filter(e => e.id !== executionId);
                    
                    // æ›´æ–°ä»»åŠ¡ç»Ÿè®¡
                    if (this.selectedTask) {
                        this.selectedTask.failed_items = Math.max(0, this.selectedTask.failed_items - 1);
                    }
                    
                    // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
                    await this.refreshTasks();
                    
                    this.showAlert('success', 'ä»»åŠ¡é‡è¯•æˆåŠŸ');
                } else {
                    this.showAlert('danger', data.detail || 'é‡è¯•å¤±è´¥');
                }
            } catch (error) {
                console.error('é‡è¯•å¤±è´¥:', error);
                this.showAlert('danger', 'é‡è¯•å¤±è´¥: ' + error.message);
            } finally {
                if (execution) {
                    execution.retrying = false;
                }
            }
        },

        // é‡è¯•æ‰€æœ‰å¤±è´¥çš„ä»»åŠ¡
        async retryAllFailedTasks(batchId) {
            this.retryingAll = true;
            try {
                const response = await fetch(`/api/batch/${batchId}/retry-failed`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (response.ok) {
                    // æ¸…ç©ºå¤±è´¥åˆ—è¡¨
                    this.failedExecutions = [];
                    
                    // æ›´æ–°ä»»åŠ¡ç»Ÿè®¡
                    if (this.selectedTask) {
                        this.selectedTask.failed_items = 0;
                    }
                    
                    // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
                    await this.refreshTasks();
                    
                    this.showAlert('success', `æˆåŠŸé‡è¯• ${data.retried_count} ä¸ªå¤±è´¥ä»»åŠ¡`);
                } else {
                    this.showAlert('danger', data.detail || 'æ‰¹é‡é‡è¯•å¤±è´¥');
                }
            } catch (error) {
                console.error('æ‰¹é‡é‡è¯•å¤±è´¥:', error);
                this.showAlert('danger', 'æ‰¹é‡é‡è¯•å¤±è´¥: ' + error.message);
            } finally {
                this.retryingAll = false;
            }
        },

        // é‡è¯•å¤±è´¥ä»»åŠ¡ï¼ˆä»ä»»åŠ¡åˆ—è¡¨è°ƒç”¨ï¼‰
        async retryFailedTasks(batchId) {
            try {
                const response = await fetch(`/api/batch/${batchId}/retry-failed`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (response.ok) {
                    this.showAlert('success', `æˆåŠŸé‡è¯• ${data.retried_count} ä¸ªå¤±è´¥ä»»åŠ¡`);
                    await this.refreshTasks();
                } else {
                    this.showAlert('danger', data.detail || 'é‡è¯•å¤±è´¥');
                }
            } catch (error) {
                console.error('é‡è¯•å¤±è´¥:', error);
                this.showAlert('danger', 'é‡è¯•å¤±è´¥: ' + error.message);
            }
        },

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        showAlert(type, message) {
            // åˆ›å»ºæç¤ºå…ƒç´ 
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 3000);
        },
        
        formatFileSize(bytes) {
            if (!bytes) return '';
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
        },
        
        getPageNumbers() {
            const pages = [];
            const total = this.pagination.pages;
            const current = this.pagination.page;
            
            if (total <= 7) {
                for (let i = 1; i <= total; i++) {
                    pages.push(i);
                }
            } else {
                if (current <= 4) {
                    for (let i = 1; i <= 5; i++) {
                        pages.push(i);
                    }
                    pages.push('...');
                    pages.push(total);
                } else if (current >= total - 3) {
                    pages.push(1);
                    pages.push('...');
                    for (let i = total - 4; i <= total; i++) {
                        pages.push(i);
                    }
                } else {
                    pages.push(1);
                    pages.push('...');
                    for (let i = current - 1; i <= current + 1; i++) {
                        pages.push(i);
                    }
                    pages.push('...');
                    pages.push(total);
                }
            }
            
            return pages;
        },
        
        showSuccessMessage(message) {
            // ç®€å•çš„æˆåŠŸæç¤ºï¼Œå¯ä»¥ç”¨æ›´å¥½çš„é€šçŸ¥ç»„ä»¶æ›¿æ¢
            const alert = document.createElement('div');
            alert.className = 'alert alert-success alert-dismissible fade show position-fixed';
            alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alert.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alert);
            
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 5000);
        }
    }
}
</script>
{% endblock %} 