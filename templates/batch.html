{% extends "base.html" %}

{% block title %}ÊâπÈáèÊâßË°å - Dify WorkflowÊâπÈáèÊâßË°åÁ≥ªÁªü{% endblock %}

{% block content %}
<div x-data="batchExecutionApp()" x-init="init()">
    <!-- È°µÈù¢Ê†áÈ¢ò -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            <i class="fas fa-tasks me-2"></i>
            ÊâπÈáèÊâßË°å
        </h2>
        <div>
            <button class="btn btn-outline-secondary me-2" @click="refreshTasks()">
                <i class="fas fa-sync-alt me-1"></i>
                Âà∑Êñ∞‰ªªÂä°
            </button>
            <button class="btn btn-primary" @click="showExecutionModal()">
                <i class="fas fa-plus me-1"></i>
                Êñ∞Âª∫ÊâπÈáè‰ªªÂä°
            </button>
        </div>
    </div>

    <!-- ‰ªªÂä°ÂàóË°® -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>
                        ÊâπÈáè‰ªªÂä°ÂàóË°®
                    </h5>
                </div>
                <div class="card-body">
                    <!-- ËøáÊª§Âô® -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="statusFilter" class="form-label">Áä∂ÊÄÅÁ≠õÈÄâ</label>
                            <select id="statusFilter" class="form-select" x-model="statusFilter" @change="loadTasks()">
                                <option value="">ÊâÄÊúâÁä∂ÊÄÅ</option>
                                <option value="pending">Á≠âÂæÖÊâßË°å</option>
                                <option value="running">ÊâßË°å‰∏≠</option>
                                <option value="completed">Â∑≤ÂÆåÊàê</option>
                                <option value="failed">ÊâßË°åÂ§±Ë¥•</option>
                                <option value="cancelled">Â∑≤ÂèñÊ∂à</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="workflowFilter" class="form-label">Â∑•‰ΩúÊµÅÁ≠õÈÄâ</label>
                            <select id="workflowFilter" class="form-select" x-model="workflowFilter" @change="loadTasks()">
                                <option value="">ÊâÄÊúâÂ∑•‰ΩúÊµÅ</option>
                                <template x-for="workflow in workflows" :key="workflow.id">
                                    <option :value="workflow.id" x-text="workflow.name"></option>
                                </template>
                            </select>
                        </div>
                    </div>

                    <!-- ‰ªªÂä°Ë°®Ê†º -->
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>‰ªªÂä°ÂêçÁß∞</th>
                                    <th>Â∑•‰ΩúÊµÅ</th>
                                    <th>Áä∂ÊÄÅ</th>
                                    <th>ËøõÂ∫¶</th>
                                    <th>ÊàêÂäü/Â§±Ë¥•</th>
                                    <th>ÂàõÂª∫Êó∂Èó¥</th>
                                    <th>Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="task in tasks" :key="task.id">
                                    <tr>
                                        <td>
                                            <strong x-text="task.name"></strong>
                                            <br>
                                            <small class="text-muted" x-text="task.original_filename"></small>
                                        </td>
                                        <td>
                                            <span x-text="getWorkflowName(task.workflow_id)"></span>
                                        </td>
                                        <td>
                                            <span class="badge" :class="getStatusBadgeClass(task.status)" x-text="getStatusText(task.status)"></span>
                                        </td>
                                        <td>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar" 
                                                     :style="`width: ${task.progress_percentage || 0}%`"
                                                     :class="getProgressBarClass(task.status)">
                                                    <span x-text="`${Math.round(task.progress_percentage || 0)}%`"></span>
                                                </div>
                                            </div>
                                            <small class="text-muted">
                                                <span x-text="task.total_items || 0"></span> È°π
                                            </small>
                                        </td>
                                        <td>
                                            <span class="text-success">
                                                <i class="fas fa-check-circle me-1"></i>
                                                <span x-text="task.completed_items || 0"></span>
                                            </span>
                                            /
                                            <span class="text-danger">
                                                <i class="fas fa-times-circle me-1"></i>
                                                <span x-text="task.failed_items || 0"></span>
                                            </span>
                                        </td>
                                        <td>
                                            <span x-text="formatDateTime(task.created_at)"></span>
                                        </td>
                                        <td style="min-width: 200px;">
                                            <div class="d-flex flex-wrap gap-1">
                                                <button class="btn btn-info btn-sm text-white" 
                                                        @click="viewTaskDetails(task)" 
                                                        title="Êü•ÁúãËØ¶ÊÉÖ">
                                                    üëÅÔ∏è Êü•ÁúãËØ¶ÊÉÖ
                                                </button>
                                                <button class="btn btn-success btn-sm" 
                                                        @click="downloadResult(task.id)" 
                                                        :disabled="task.status !== 'completed'"
                                                        title="‰∏ãËΩΩÁªìÊûú">
                                                    üì• ‰∏ãËΩΩÁªìÊûú
                                                </button>
                                                <!-- ÊöÇÂÅúÊåâÈíÆ -->
                                                <button class="btn btn-warning btn-sm" 
                                                        @click="pauseTask(task.id)" 
                                                        x-show="task.status === 'running'"
                                                        title="ÊöÇÂÅú‰ªªÂä°">
                                                    ‚è∏Ô∏è ÊöÇÂÅú
                                                </button>
                                                <!-- ÊÅ¢Â§çÊåâÈíÆ -->
                                                <button class="btn btn-primary btn-sm" 
                                                        @click="resumeTask(task.id)" 
                                                        x-show="task.status === 'paused'"
                                                        title="ÊÅ¢Â§ç‰ªªÂä°">
                                                    ‚ñ∂Ô∏è ÊÅ¢Â§ç
                                                </button>
                                                <!-- ÂÅúÊ≠¢ÊåâÈíÆ -->
                                                <button class="btn btn-warning btn-sm" 
                                                        @click="stopTask(task.id)" 
                                                        x-show="task.status === 'running' || task.status === 'paused'"
                                                        title="ÂÅúÊ≠¢‰ªªÂä°">
                                                    ‚èπÔ∏è ÂÅúÊ≠¢
                                                </button>
                                                <!-- ÈáçËØïÂ§±Ë¥•‰ªªÂä°ÊåâÈíÆ -->
                                                <button class="btn btn-secondary btn-sm" 
                                                        @click="retryFailedTasks(task.id)" 
                                                        x-show="task.status === 'completed' && task.failed_items > 0"
                                                        title="ÈáçËØïÂ§±Ë¥•‰ªªÂä°">
                                                    üîÑ ÈáçËØïÂ§±Ë¥•
                                                </button>
                                                <button class="btn btn-danger btn-sm" 
                                                        @click="deleteTask(task.id)" 
                                                        :disabled="task.status === 'running' || task.status === 'paused'"
                                                        title="Âà†Èô§‰ªªÂä°">
                                                    üóëÔ∏è Âà†Èô§‰ªªÂä°
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </template>
                                <tr x-show="tasks.length === 0">
                                    <td colspan="7" class="text-center text-muted py-4">
                                        <i class="fas fa-inbox fa-2x mb-2"></i>
                                        <br>
                                        ÊöÇÊó†ÊâπÈáè‰ªªÂä°
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- ÂàÜÈ°µ -->
                    <nav x-show="pagination.pages > 1">
                        <ul class="pagination justify-content-center">
                            <li class="page-item" :class="{ disabled: pagination.page <= 1 }">
                                <a class="page-link" href="#" @click.prevent="loadTasks(pagination.page - 1)">‰∏ä‰∏ÄÈ°µ</a>
                            </li>
                            <template x-for="page in getPageNumbers()" :key="page">
                                <li class="page-item" :class="{ active: page === pagination.page }">
                                    <a class="page-link" href="#" @click.prevent="loadTasks(page)" x-text="page"></a>
                                </li>
                            </template>
                            <li class="page-item" :class="{ disabled: pagination.page >= pagination.pages }">
                                <a class="page-link" href="#" @click.prevent="loadTasks(pagination.page + 1)">‰∏ã‰∏ÄÈ°µ</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Êñ∞Âª∫ÊâπÈáè‰ªªÂä°Ê®°ÊÄÅÊ°Ü -->
    <div class="modal fade" :class="{ show: showModal }" :style="{ display: showModal ? 'block' : 'none' }" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plus me-2"></i>
                        Êñ∞Âª∫ÊâπÈáè‰ªªÂä°
                    </h5>
                    <button type="button" class="btn-close" @click="hideExecutionModal()" aria-label="ÂÖ≥Èó≠"></button>
                </div>
                <div class="modal-body">
                    <!-- Ê≠•È™§ÊåáÁ§∫Âô® -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="d-flex justify-content-between">
                                <div class="step" :class="{ active: currentStep >= 1, completed: currentStep > 1 }">
                                    <div class="step-number">1</div>
                                    <div class="step-title">ÈÄâÊã©Â∑•‰ΩúÊµÅ</div>
                                </div>
                                <div class="step" :class="{ active: currentStep >= 2, completed: currentStep > 2 }">
                                    <div class="step-number">2</div>
                                    <div class="step-title">‰∏ä‰º†Êñá‰ª∂</div>
                                </div>
                                <div class="step" :class="{ active: currentStep >= 3, completed: currentStep > 3 }">
                                    <div class="step-number">3</div>
                                    <div class="step-title">ÈÖçÁΩÆÊâßË°å</div>
                                </div>
                                <div class="step" :class="{ active: currentStep >= 4 }">
                                    <div class="step-number">4</div>
                                    <div class="step-title">ÂºÄÂßãÊâßË°å</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ê≠•È™§1: ÈÄâÊã©Â∑•‰ΩúÊµÅ -->
                    <div x-show="currentStep === 1">
                        <h6>ÈÄâÊã©Ë¶ÅÊâßË°åÁöÑÂ∑•‰ΩúÊµÅ</h6>
                        <div class="row">
                            <template x-for="workflow in workflows" :key="workflow.id">
                                <div class="col-md-6 mb-3">
                                    <div class="card workflow-card" 
                                         :class="{ selected: selectedWorkflow?.id === workflow.id }"
                                         @click="selectWorkflow(workflow)">
                                        <div class="card-body">
                                            <h6 class="card-title" x-text="workflow.app_name || workflow.name"></h6>
                                            <p class="card-text text-muted" x-text="workflow.app_description || workflow.description || 'Êó†ÊèèËø∞'"></p>
                                            <small class="text-muted">
                                                <i class="fas fa-tag me-1"></i>
                                                <span x-text="workflow.name"></span>
                                                <span class="ms-2">
                                                    <i class="fas fa-link me-1"></i>
                                                    <span x-text="workflow.base_url"></span>
                                                </span>
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <div x-show="workflows.length === 0" class="text-center text-muted py-4">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                            <br>
                            ÊöÇÊó†ÂèØÁî®Â∑•‰ΩúÊµÅÔºåËØ∑ÂÖàÊ∑ªÂä†Â∑•‰ΩúÊµÅÈÖçÁΩÆ
                        </div>
                    </div>

                    <!-- Ê≠•È™§2: ‰∏ä‰º†Êñá‰ª∂ -->
                    <div x-show="currentStep === 2">
                        <h6>‰∏ä‰º†ExcelÊñá‰ª∂</h6>
                        <div class="mb-3">
                            <button class="btn btn-outline-primary me-2" @click="downloadTemplate()" :disabled="!selectedWorkflow">
                                <i class="fas fa-download me-1"></i>
                                ‰∏ãËΩΩExcelÊ®°Êùø
                            </button>
                            <small class="text-muted">Âª∫ËÆÆÂÖà‰∏ãËΩΩÊ®°ÊùøÔºåÊåâÊ†ºÂºèÂ°´ÂÜôÊï∞ÊçÆÂêé‰∏ä‰º†</small>
                        </div>
                        
                        <div class="upload-area" 
                             @dragover.prevent 
                             @drop.prevent="handleFileDrop($event)"
                             :class="{ 'drag-over': isDragOver }"
                             @dragenter="isDragOver = true"
                             @dragleave="isDragOver = false">
                                                         <input type="file" 
                                    id="fileInput" 
                                    accept=".xlsx,.xls" 
                                    @change="handleFileSelect($event)"
                                    style="display: none;"
                                    aria-label="ÈÄâÊã©ExcelÊñá‰ª∂">
                             <div class="text-center py-4">
                                 <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                 <h6>ÊãñÊãΩÊñá‰ª∂Âà∞Ê≠§Â§ÑÊàñÁÇπÂáªÈÄâÊã©Êñá‰ª∂</h6>
                                 <p class="text-muted">ÊîØÊåÅ .xlsx Âíå .xls Ê†ºÂºè</p>
                                 <button class="btn btn-outline-primary" @click="document.getElementById('fileInput').click()" aria-label="ÈÄâÊã©Êñá‰ª∂">
                                     ÈÄâÊã©Êñá‰ª∂
                                 </button>
                             </div>
                        </div>

                        <div x-show="selectedFile" class="mt-3">
                            <div class="alert alert-info">
                                <i class="fas fa-file-excel me-2"></i>
                                Â∑≤ÈÄâÊã©Êñá‰ª∂: <strong x-text="selectedFile?.name"></strong>
                                <span class="ms-2 text-muted" x-text="formatFileSize(selectedFile?.size)"></span>
                            </div>
                        </div>

                        <div x-show="uploadProgress > 0 && uploadProgress < 100" class="mt-3">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     :style="`width: ${uploadProgress}%`">
                                    <span x-text="`${uploadProgress}%`"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ê≠•È™§3: ÈÖçÁΩÆÊâßË°å -->
                    <div x-show="currentStep === 3">
                        <h6>ÊâßË°åÈÖçÁΩÆ</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">‰ªªÂä°ÂêçÁß∞</label>
                                <input type="text" class="form-control" x-model="executionConfig.taskName" placeholder="ËæìÂÖ•‰ªªÂä°ÂêçÁß∞">
                            </div>
                                                         <div class="col-md-6">
                                 <label for="maxConcurrency" class="form-label">ÊúÄÂ§ßÂπ∂ÂèëÊï∞</label>
                                 <select id="maxConcurrency" class="form-select" x-model="executionConfig.maxConcurrency">
                                     <option value="1">1 (‰∏≤Ë°åÊâßË°å)</option>
                                     <option value="2">2</option>
                                     <option value="3">3 (Êé®Ëçê)</option>
                                     <option value="5">5</option>
                                     <option value="10">10</option>
                                 </select>
                             </div>
                         </div>
                         <div class="row mt-3">
                             <div class="col-md-6">
                                 <label for="retryCount" class="form-label">ÈáçËØïÊ¨°Êï∞</label>
                                 <select id="retryCount" class="form-select" x-model="executionConfig.retryCount">
                                     <option value="0">0 (‰∏çÈáçËØï)</option>
                                     <option value="1">1</option>
                                     <option value="2">2 (Êé®Ëçê)</option>
                                     <option value="3">3</option>
                                     <option value="5">5</option>
                                 </select>
                             </div>
                             <div class="col-md-6">
                                 <label for="timeoutSeconds" class="form-label">Ë∂ÖÊó∂Êó∂Èó¥ (Áßí)</label>
                                 <select id="timeoutSeconds" class="form-select" x-model="executionConfig.timeoutSeconds">
                                     <option value="60">60</option>
                                     <option value="120">120</option>
                                     <option value="300">300 (Êé®Ëçê)</option>
                                     <option value="600">600</option>
                                     <option value="1200">1200</option>
                                 </select>
                             </div>
                        </div>
                    </div>

                    <!-- Ê≠•È™§4: Á°ÆËÆ§ÊâßË°å -->
                    <div x-show="currentStep === 4">
                        <h6>Á°ÆËÆ§ÊâßË°å‰ø°ÊÅØ</h6>
                        <div class="card">
                            <div class="card-body">
                                <dl class="row">
                                    <dt class="col-sm-3">Â∫îÁî®:</dt>
                                    <dd class="col-sm-9" x-text="selectedWorkflow?.app_name || selectedWorkflow?.name"></dd>
                                    
                                    <dt class="col-sm-3">Êñá‰ª∂:</dt>
                                    <dd class="col-sm-9" x-text="selectedFile?.name"></dd>
                                    
                                    <dt class="col-sm-3">‰ªªÂä°ÂêçÁß∞:</dt>
                                    <dd class="col-sm-9" x-text="executionConfig.taskName"></dd>
                                    
                                    <dt class="col-sm-3">Âπ∂ÂèëÊï∞:</dt>
                                    <dd class="col-sm-9" x-text="executionConfig.maxConcurrency"></dd>
                                    
                                    <dt class="col-sm-3">ÈáçËØïÊ¨°Êï∞:</dt>
                                    <dd class="col-sm-9" x-text="executionConfig.retryCount"></dd>
                                    
                                    <dt class="col-sm-3">Ë∂ÖÊó∂Êó∂Èó¥:</dt>
                                    <dd class="col-sm-9" x-text="`${executionConfig.timeoutSeconds} Áßí`"></dd>
                                </dl>
                            </div>
                        </div>
                    </div>

                    <!-- ÈîôËØØÊèêÁ§∫ -->
                    <div x-show="error" class="alert alert-danger mt-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span x-text="error"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @click="hideExecutionModal()">ÂèñÊ∂à</button>
                    <button type="button" class="btn btn-outline-secondary" @click="previousStep()" x-show="currentStep > 1">‰∏ä‰∏ÄÊ≠•</button>
                    <button type="button" class="btn btn-primary" @click="nextStep()" x-show="currentStep < 4" :disabled="!canProceedToNextStep()">‰∏ã‰∏ÄÊ≠•</button>
                    <button type="button" class="btn btn-success" @click="startExecution()" x-show="currentStep === 4" :disabled="processing">
                        <span x-show="processing">
                            <i class="fas fa-spinner fa-spin me-1"></i>
                            ÊâßË°å‰∏≠...
                        </span>
                        <span x-show="!processing">
                            <i class="fas fa-play me-1"></i>
                            ÂºÄÂßãÊâßË°å
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ‰ªªÂä°ËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü -->
    <div class="modal fade" :class="{ show: showDetailsModal }" :style="{ display: showDetailsModal ? 'block' : 'none' }" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-info-circle me-2"></i>
                        ‰ªªÂä°ËØ¶ÊÉÖ
                    </h5>
                                         <button type="button" class="btn-close" @click="hideDetailsModal()" aria-label="ÂÖ≥Èó≠"></button>
                </div>
                <div class="modal-body" x-show="selectedTask">
                    <!-- ‰ªªÂä°Âü∫Êú¨‰ø°ÊÅØ -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6>Âü∫Êú¨‰ø°ÊÅØ</h6>
                            <dl class="row">
                                <dt class="col-sm-4">‰ªªÂä°ÂêçÁß∞:</dt>
                                <dd class="col-sm-8" x-text="selectedTask?.name"></dd>
                                <dt class="col-sm-4">Áä∂ÊÄÅ:</dt>
                                <dd class="col-sm-8">
                                    <span class="badge" :class="getStatusBadgeClass(selectedTask?.status)" x-text="getStatusText(selectedTask?.status)"></span>
                                </dd>
                                <dt class="col-sm-4">Â∑•‰ΩúÊµÅ:</dt>
                                <dd class="col-sm-8" x-text="getWorkflowName(selectedTask?.workflow_id)"></dd>
                            </dl>
                        </div>
                        <div class="col-md-6">
                            <h6>ÊâßË°åÁªüËÆ°</h6>
                            <dl class="row">
                                <dt class="col-sm-4">ÊÄªÈ°πÁõÆÊï∞:</dt>
                                <dd class="col-sm-8" x-text="selectedTask?.total_items || 0"></dd>
                                <dt class="col-sm-4">Â∑≤ÂÆåÊàê:</dt>
                                <dd class="col-sm-8 text-success" x-text="selectedTask?.completed_items || 0"></dd>
                                <dt class="col-sm-4">Â§±Ë¥•:</dt>
                                <dd class="col-sm-8 text-danger" x-text="selectedTask?.failed_items || 0"></dd>
                                <dt class="col-sm-4">ÊàêÂäüÁéá:</dt>
                                <dd class="col-sm-8" x-text="`${Math.round(selectedTask?.success_rate || 0)}%`"></dd>
                            </dl>
                        </div>
                    </div>

                    <!-- ËøõÂ∫¶Êù° -->
                    <div class="mb-4">
                        <h6>ÊâßË°åËøõÂ∫¶</h6>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar" 
                                 :style="`width: ${selectedTask?.progress_percentage || 0}%`"
                                 :class="getProgressBarClass(selectedTask?.status)">
                                <span x-text="`${Math.round(selectedTask?.progress_percentage || 0)}%`"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Êó∂Èó¥‰ø°ÊÅØ -->
                    <div class="mb-4">
                        <h6>Êó∂Èó¥‰ø°ÊÅØ</h6>
                        <dl class="row">
                            <dt class="col-sm-2">ÂàõÂª∫Êó∂Èó¥:</dt>
                            <dd class="col-sm-4" x-text="formatDateTime(selectedTask?.created_at)"></dd>
                            <dt class="col-sm-2">ÂºÄÂßãÊó∂Èó¥:</dt>
                            <dd class="col-sm-4" x-text="formatDateTime(selectedTask?.started_at)"></dd>
                            <dt class="col-sm-2">ÂÆåÊàêÊó∂Èó¥:</dt>
                            <dd class="col-sm-4" x-text="formatDateTime(selectedTask?.completed_at)"></dd>
                            <dt class="col-sm-2">ÊâßË°åÊó∂Èïø:</dt>
                            <dd class="col-sm-4" x-text="formatDuration(selectedTask?.duration_seconds)"></dd>
                        </dl>
                    </div>

                    <!-- ÈîôËØØ‰ø°ÊÅØ -->
                    <div x-show="selectedTask?.error_message" class="mb-4">
                        <h6>ÈîôËØØ‰ø°ÊÅØ</h6>
                        <div class="alert alert-danger">
                            <span x-text="selectedTask?.error_message"></span>
                        </div>
                    </div>

                    <!-- Â§±Ë¥•‰ªªÂä°ÂàóË°® -->
                    <div x-show="selectedTask?.failed_items > 0" class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">
                                <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                                Â§±Ë¥•‰ªªÂä°ÂàóË°® (<span x-text="selectedTask?.failed_items || 0"></span>)
                            </h6>
                            <button class="btn btn-outline-primary btn-sm" 
                                    @click="retryAllFailedTasks(selectedTask.id)"
                                    :disabled="retryingAll">
                                <span x-show="!retryingAll">üîÑ ÈáçËØïÊâÄÊúâÂ§±Ë¥•‰ªªÂä°</span>
                                <span x-show="retryingAll">‚è≥ ÈáçËØï‰∏≠...</span>
                            </button>
                        </div>
                        
                        <div x-show="!failedExecutions.length" class="text-center py-3">
                            <button class="btn btn-outline-secondary btn-sm" 
                                    @click="loadFailedExecutions(selectedTask.id)"
                                    :disabled="loadingFailed">
                                <span x-show="!loadingFailed">üìã Âä†ËΩΩÂ§±Ë¥•‰ªªÂä°ËØ¶ÊÉÖ</span>
                                <span x-show="loadingFailed">‚è≥ Âä†ËΩΩ‰∏≠...</span>
                            </button>
                        </div>
                        
                        <div x-show="failedExecutions.length" class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-striped">
                                <thead class="table-dark sticky-top">
                                    <tr>
                                        <th>Ë°åÂè∑</th>
                                        <th>ËæìÂÖ•Êï∞ÊçÆ</th>
                                        <th>ÈîôËØØ‰ø°ÊÅØ</th>
                                        <th>ÈáçËØïÊ¨°Êï∞</th>
                                        <th>Êìç‰Ωú</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="execution in failedExecutions" :key="execution.id">
                                        <tr>
                                            <td x-text="execution.row_index + 1"></td>
                                            <td>
                                                <small x-text="JSON.stringify(execution.inputs).substring(0, 50) + '...'"></small>
                                            </td>
                                            <td>
                                                <small class="text-danger" x-text="execution.error_message?.substring(0, 100) + '...'"></small>
                                            </td>
                                            <td x-text="execution.retry_count || 0"></td>
                                            <td>
                                                <button class="btn btn-outline-primary btn-xs" 
                                                        @click="retrySingleExecution(selectedTask.id, execution.id)"
                                                        :disabled="execution.retrying"
                                                        title="ÈáçËØïÊ≠§‰ªªÂä°">
                                                    <span x-show="!execution.retrying">üîÑ</span>
                                                    <span x-show="execution.retrying">‚è≥</span>
                                                </button>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @click="hideDetailsModal()">ÂÖ≥Èó≠</button>
                    <button type="button" class="btn btn-success" 
                            @click="downloadResult(selectedTask?.id)" 
                            :disabled="selectedTask?.status !== 'completed'">
                        <i class="fas fa-download me-1"></i>
                        ‰∏ãËΩΩÁªìÊûú
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ê®°ÊÄÅÊ°ÜËÉåÊôØ -->
    <div class="modal-backdrop fade" :class="{ show: showModal || showDetailsModal }" x-show="showModal || showDetailsModal"></div>
</div>

<style>
.step {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    flex: 1;
}

.step:not(:last-child)::after {
    content: '';
    position: absolute;
    top: 15px;
    left: 60%;
    right: -40%;
    height: 2px;
    background-color: #dee2e6;
    z-index: 1;
}

.step.completed:not(:last-child)::after {
    background-color: #198754;
}

.step-number {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background-color: #dee2e6;
    color: #6c757d;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-bottom: 8px;
    position: relative;
    z-index: 2;
}

.step.active .step-number {
    background-color: #0d6efd;
    color: white;
}

.step.completed .step-number {
    background-color: #198754;
    color: white;
}

.step-title {
    font-size: 12px;
    text-align: center;
    color: #6c757d;
}

.step.active .step-title {
    color: #0d6efd;
    font-weight: bold;
}

.step.completed .step-title {
    color: #198754;
}

.workflow-card {
    cursor: pointer;
    transition: all 0.2s;
    border: 2px solid transparent;
}

.workflow-card:hover {
    border-color: #0d6efd;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.workflow-card.selected {
    border-color: #0d6efd;
    background-color: #f8f9ff;
}

.upload-area {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    transition: all 0.2s;
    cursor: pointer;
}

.upload-area:hover,
.upload-area.drag-over {
    border-color: #0d6efd;
    background-color: #f8f9ff;
}

/* ‰øÆÂ§çÊåâÈíÆÁªÑÊòæÁ§∫ */
.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    line-height: 1.5;
    border-radius: 0.2rem;
}

.btn-group .btn:not(:last-child) {
    border-top-right-radius: 0;
    border-bottom-right-radius: 0;
}

.btn-group .btn:not(:first-child) {
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
    margin-left: -1px;
}

/* Á°Æ‰øùËøõÂ∫¶Êù°Ê≠£Á°ÆÊòæÁ§∫ */
.progress {
    height: 1.5rem;
    font-size: 0.75rem;
    background-color: #e9ecef;
    border-radius: 0.375rem;
}

.progress-bar {
    display: flex;
    flex-direction: column;
    justify-content: center;
    overflow: hidden;
    color: #fff;
    text-align: center;
    white-space: nowrap;
    background-color: #0d6efd;
    transition: width 0.6s ease;
}

/* Ë°®Ê†ºÂçïÂÖÉÊ†ºÂØπÈΩê */
.table td {
    vertical-align: middle;
}

/* Êìç‰ΩúÂàóÂõ∫ÂÆöÂÆΩÂ∫¶ */
.table th:last-child,
.table td:last-child {
    width: 160px;
    min-width: 160px;
}
</style>

<script>
function batchExecutionApp() {
    return {
        // Êï∞ÊçÆÁä∂ÊÄÅ
        tasks: [],
        workflows: [],
        pagination: {
            page: 1,
            size: 10,
            total: 0,
            pages: 0
        },
        
        // ËøáÊª§Âô®
        statusFilter: '',
        workflowFilter: '',
        
        // Ê®°ÊÄÅÊ°ÜÁä∂ÊÄÅ
        showModal: false,
        showDetailsModal: false,
        currentStep: 1,
        
        // ÈÄâÊã©ÁöÑÊï∞ÊçÆ
        selectedWorkflow: null,
        selectedFile: null,
        selectedTask: null,
        failedExecutions: [],
        loadingFailed: false,
        retryingAll: false,
        
        // ÊâßË°åÈÖçÁΩÆ
        executionConfig: {
            taskName: '',
            maxConcurrency: 3,
            retryCount: 2,
            timeoutSeconds: 300
        },
        
        // UIÁä∂ÊÄÅ
        processing: false,
        error: '',
        uploadProgress: 0,
        isDragOver: false,
        
        // ÂàùÂßãÂåñ
        async init() {
            await this.loadWorkflows();
            await this.loadTasks();
            this.startAutoRefresh();
        },
        
        // Âä†ËΩΩÂ∑•‰ΩúÊµÅÂàóË°®
        async loadWorkflows() {
            try {
                const response = await fetch('/api/workflows/');
                const data = await response.json();
                // APIÁõ¥Êé•ËøîÂõûÂ∑•‰ΩúÊµÅÊï∞ÁªÑÔºå‰∏çÊòØÂåÖË£ÖÂú®workflowsÂ≠óÊÆµ‰∏≠
                this.workflows = Array.isArray(data) ? data : (data.workflows || []);
            } catch (error) {
                console.error('Âä†ËΩΩÂ∑•‰ΩúÊµÅÂ§±Ë¥•:', error);
            }
        },
        
        // Âä†ËΩΩ‰ªªÂä°ÂàóË°®
        async loadTasks(page = 1) {
            try {
                const params = new URLSearchParams({
                    page: page,
                    size: this.pagination.size
                });
                
                if (this.statusFilter) params.append('status', this.statusFilter);
                if (this.workflowFilter) params.append('workflow_id', this.workflowFilter);
                
                const response = await fetch(`/api/batch/?${params}`);
                const data = await response.json();
                
                this.tasks = data.tasks || [];
                this.pagination = {
                    page: data.page || 1,
                    size: data.size || 10,
                    total: data.total || 0,
                    pages: data.pages || 0
                };
            } catch (error) {
                console.error('Âä†ËΩΩ‰ªªÂä°ÂàóË°®Â§±Ë¥•:', error);
            }
        },
        
        // Âà∑Êñ∞‰ªªÂä°
        async refreshTasks() {
            await this.loadTasks(this.pagination.page);
        },
        
        // Ëá™Âä®Âà∑Êñ∞
        startAutoRefresh() {
            setInterval(() => {
                if (!this.showModal && !this.showDetailsModal) {
                    this.refreshTasks();
                }
            }, 5000); // ÊØè5ÁßíÂà∑Êñ∞‰∏ÄÊ¨°
        },
        
        // ÊòæÁ§∫ÊâßË°åÊ®°ÊÄÅÊ°Ü
        showExecutionModal() {
            this.showModal = true;
            this.currentStep = 1;
            this.selectedWorkflow = null;
            this.selectedFile = null;
            this.executionConfig.taskName = '';
            this.error = '';
        },
        
        // ÈöêËóèÊâßË°åÊ®°ÊÄÅÊ°Ü
        hideExecutionModal() {
            this.showModal = false;
            this.currentStep = 1;
            this.selectedWorkflow = null;
            this.selectedFile = null;
            this.error = '';
            this.uploadProgress = 0;
        },
        
        // ÈÄâÊã©Â∑•‰ΩúÊµÅ
        selectWorkflow(workflow) {
            this.selectedWorkflow = workflow;
            this.executionConfig.taskName = `${workflow.app_name || workflow.name} - ÊâπÈáè‰ªªÂä°`;
        },
        
        // ‰∏ãËΩΩÊ®°Êùø
        async downloadTemplate() {
            if (!this.selectedWorkflow) return;
            
            try {
                const response = await fetch(`/api/workflows/${this.selectedWorkflow.id}/template`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${this.selectedWorkflow.name}_Ê®°Êùø.xlsx`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                } else {
                    this.error = '‰∏ãËΩΩÊ®°ÊùøÂ§±Ë¥•';
                }
            } catch (error) {
                this.error = '‰∏ãËΩΩÊ®°ÊùøÂ§±Ë¥•: ' + error.message;
            }
        },
        
        // Â§ÑÁêÜÊñá‰ª∂ÈÄâÊã©
        handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                this.selectedFile = file;
            }
        },
        
        // Â§ÑÁêÜÊñá‰ª∂ÊãñÊãΩ
        handleFileDrop(event) {
            this.isDragOver = false;
            const file = event.dataTransfer.files[0];
            if (file && (file.name.endsWith('.xlsx') || file.name.endsWith('.xls'))) {
                this.selectedFile = file;
            }
        },
        
        // ‰∏ã‰∏ÄÊ≠•
        nextStep() {
            if (this.canProceedToNextStep()) {
                this.currentStep++;
                this.error = '';
            }
        },
        
        // ‰∏ä‰∏ÄÊ≠•
        previousStep() {
            if (this.currentStep > 1) {
                this.currentStep--;
                this.error = '';
            }
        },
        
        // Ê£ÄÊü•ÊòØÂê¶ÂèØ‰ª•ËøõÂÖ•‰∏ã‰∏ÄÊ≠•
        canProceedToNextStep() {
            switch (this.currentStep) {
                case 1:
                    return this.selectedWorkflow !== null;
                case 2:
                    return this.selectedFile !== null;
                case 3:
                    return this.executionConfig.taskName.trim() !== '';
                default:
                    return false;
            }
        },
        
        // ÂºÄÂßãÊâßË°å
        async startExecution() {
            if (!this.selectedWorkflow || !this.selectedFile) return;
            
            this.processing = true;
            this.error = '';
            
            try {
                // 1. ‰∏ä‰º†Êñá‰ª∂
                const formData = new FormData();
                formData.append('file', this.selectedFile);
                formData.append('workflow_id', this.selectedWorkflow.id);
                
                const uploadResponse = await fetch('/api/batch/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const uploadData = await uploadResponse.json();
                
                if (!uploadResponse.ok) {
                    throw new Error(uploadData.detail?.message || uploadData.detail || 'Êñá‰ª∂‰∏ä‰º†Â§±Ë¥•');
                }
                
                // 2. ÂêØÂä®ÊâπÈáèÊâßË°å
                const executeFormData = new FormData();
                executeFormData.append('file_id', uploadData.file_id);
                executeFormData.append('workflow_id', this.selectedWorkflow.id);
                executeFormData.append('task_name', this.executionConfig.taskName);
                executeFormData.append('max_concurrency', this.executionConfig.maxConcurrency);
                executeFormData.append('retry_count', this.executionConfig.retryCount);
                executeFormData.append('timeout_seconds', this.executionConfig.timeoutSeconds);
                
                const executeResponse = await fetch('/api/batch/execute', {
                    method: 'POST',
                    body: executeFormData
                });
                
                const executeData = await executeResponse.json();
                
                if (!executeResponse.ok) {
                    throw new Error(executeData.detail?.message || executeData.detail || 'ÂêØÂä®ÊâßË°åÂ§±Ë¥•');
                }
                
                // ÊàêÂäü
                this.hideExecutionModal();
                await this.loadTasks();
                
                // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
                this.showSuccessMessage('ÊâπÈáè‰ªªÂä°Â∑≤ÂêØÂä®ÔºåÊ≠£Âú®ÊâßË°å‰∏≠...');
                
            } catch (error) {
                this.error = error.message;
            } finally {
                this.processing = false;
            }
        },
        
        // Êü•Áúã‰ªªÂä°ËØ¶ÊÉÖ
        async viewTaskDetails(task) {
            try {
                const response = await fetch(`/api/batch/${task.id}/status`);
                const data = await response.json();
                this.selectedTask = data;
                this.showDetailsModal = true;
            } catch (error) {
                console.error('Ëé∑Âèñ‰ªªÂä°ËØ¶ÊÉÖÂ§±Ë¥•:', error);
            }
        },
        
        // ÈöêËóèËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü
        hideDetailsModal() {
            this.showDetailsModal = false;
            this.selectedTask = null;
            this.failedExecutions = [];
        },
        
        // ‰∏ãËΩΩÁªìÊûú
        async downloadResult(taskId) {
            try {
                const response = await fetch(`/api/batch/${taskId}/download`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `batch_result_${taskId}.xlsx`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                } else {
                    alert('‰∏ãËΩΩÂ§±Ë¥•');
                }
            } catch (error) {
                alert('‰∏ãËΩΩÂ§±Ë¥•: ' + error.message);
            }
        },
        
        // ÊöÇÂÅú‰ªªÂä°
        async pauseTask(taskId) {
            if (!confirm('Á°ÆÂÆöË¶ÅÊöÇÂÅúËøô‰∏™‰ªªÂä°ÂêóÔºü')) return;
            
            try {
                const response = await fetch(`/api/batch/${taskId}/pause`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    await this.loadTasks();
                    this.showSuccessMessage(result.message || '‰ªªÂä°Â∑≤ÊöÇÂÅú');
                } else {
                    const error = await response.json();
                    alert(`ÊöÇÂÅú‰ªªÂä°Â§±Ë¥•: ${error.detail || 'Êú™Áü•ÈîôËØØ'}`);
                }
            } catch (error) {
                console.error('ÊöÇÂÅú‰ªªÂä°Â§±Ë¥•:', error);
                alert('ÊöÇÂÅú‰ªªÂä°Â§±Ë¥•: ' + error.message);
            }
        },
        
        // ÊÅ¢Â§ç‰ªªÂä°
        async resumeTask(taskId) {
            if (!confirm('Á°ÆÂÆöË¶ÅÊÅ¢Â§çËøô‰∏™‰ªªÂä°ÂêóÔºü')) return;
            
            try {
                const response = await fetch(`/api/batch/${taskId}/resume`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    await this.loadTasks();
                    this.showSuccessMessage(result.message || '‰ªªÂä°Â∑≤ÊÅ¢Â§ç');
                } else {
                    const error = await response.json();
                    alert(`ÊÅ¢Â§ç‰ªªÂä°Â§±Ë¥•: ${error.detail || 'Êú™Áü•ÈîôËØØ'}`);
                }
            } catch (error) {
                console.error('ÊÅ¢Â§ç‰ªªÂä°Â§±Ë¥•:', error);
                alert('ÊÅ¢Â§ç‰ªªÂä°Â§±Ë¥•: ' + error.message);
            }
        },
        
        // ÂÅúÊ≠¢‰ªªÂä°
        async stopTask(taskId) {
            if (!confirm('Á°ÆÂÆöË¶ÅÂÅúÊ≠¢Ëøô‰∏™‰ªªÂä°ÂêóÔºü')) return;
            
            try {
                const response = await fetch(`/api/batch/${taskId}/stop`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    await this.loadTasks();
                    this.showSuccessMessage(result.message || '‰ªªÂä°Â∑≤ÂÅúÊ≠¢');
                } else {
                    const error = await response.json();
                    alert(`ÂÅúÊ≠¢‰ªªÂä°Â§±Ë¥•: ${error.detail || 'Êú™Áü•ÈîôËØØ'}`);
                }
            } catch (error) {
                console.error('ÂÅúÊ≠¢‰ªªÂä°Â§±Ë¥•:', error);
                alert('ÂÅúÊ≠¢‰ªªÂä°Â§±Ë¥•: ' + error.message);
            }
        },
        
        // Âà†Èô§‰ªªÂä°
        async deleteTask(taskId) {
            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™‰ªªÂä°ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ')) return;
            
            try {
                const response = await fetch(`/api/batch/${taskId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    await this.loadTasks();
                    this.showSuccessMessage(result.message || '‰ªªÂä°Â∑≤Âà†Èô§');
                } else {
                    const error = await response.json();
                    alert(`Âà†Èô§‰ªªÂä°Â§±Ë¥•: ${error.detail || 'Êú™Áü•ÈîôËØØ'}`);
                }
            } catch (error) {
                console.error('Âà†Èô§‰ªªÂä°Â§±Ë¥•:', error);
                alert('Âà†Èô§‰ªªÂä°Â§±Ë¥•: ' + error.message);
            }
        },
        
        // Â∑•ÂÖ∑ÊñπÊ≥ï
        getWorkflowName(workflowId) {
            const workflow = this.workflows.find(w => w.id === workflowId);
            return workflow ? workflow.name : 'Êú™Áü•Â∑•‰ΩúÊµÅ';
        },
        
        getStatusText(status) {
            const statusMap = {
                'pending': 'Á≠âÂæÖÊâßË°å',
                'running': 'ÊâßË°å‰∏≠',
                'paused': 'Â∑≤ÊöÇÂÅú',
                'completed': 'Â∑≤ÂÆåÊàê',
                'failed': 'ÊâßË°åÂ§±Ë¥•',
                'cancelled': 'Â∑≤ÂèñÊ∂à'
            };
            return statusMap[status] || status;
        },
        
        getStatusBadgeClass(status) {
            const classMap = {
                'pending': 'bg-secondary',
                'running': 'bg-primary',
                'paused': 'bg-warning',
                'completed': 'bg-success',
                'failed': 'bg-danger',
                'cancelled': 'bg-warning'
            };
            return classMap[status] || 'bg-secondary';
        },
        
        getProgressBarClass(status) {
            const classMap = {
                'running': 'progress-bar-striped progress-bar-animated',
                'completed': 'bg-success',
                'failed': 'bg-danger',
                'cancelled': 'bg-warning'
            };
            return classMap[status] || '';
        },
        
        formatDateTime(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleString('zh-CN');
        },
        
        formatDuration(seconds) {
            if (!seconds) return '-';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours}Â∞èÊó∂${minutes}ÂàÜÈíü${secs}Áßí`;
            } else if (minutes > 0) {
                return `${minutes}ÂàÜÈíü${secs}Áßí`;
            } else {
                return `${secs}Áßí`;
            }
        },

        // Âä†ËΩΩÂ§±Ë¥•ÁöÑÊâßË°åËÆ∞ÂΩï
        async loadFailedExecutions(batchId) {
            this.loadingFailed = true;
            try {
                const response = await fetch(`/api/batch/${batchId}/failed-executions`);
                const data = await response.json();
                
                if (response.ok) {
                    this.failedExecutions = data.failed_executions || [];
                } else {
                    this.error = data.detail || 'Âä†ËΩΩÂ§±Ë¥•‰ªªÂä°Â§±Ë¥•';
                }
            } catch (error) {
                console.error('Âä†ËΩΩÂ§±Ë¥•‰ªªÂä°Â§±Ë¥•:', error);
                this.error = 'Âä†ËΩΩÂ§±Ë¥•‰ªªÂä°Â§±Ë¥•: ' + error.message;
            } finally {
                this.loadingFailed = false;
            }
        },

        // ÈáçËØïÂçï‰∏™Â§±Ë¥•ÁöÑÊâßË°å‰ªªÂä°
        async retrySingleExecution(batchId, executionId) {
            // ËÆæÁΩÆÈáçËØïÁä∂ÊÄÅ
            const execution = this.failedExecutions.find(e => e.id === executionId);
            if (execution) {
                execution.retrying = true;
            }

            try {
                const response = await fetch(`/api/batch/${batchId}/executions/${executionId}/retry`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (response.ok) {
                    // ‰ªéÂ§±Ë¥•ÂàóË°®‰∏≠ÁßªÈô§ËØ•‰ªªÂä°
                    this.failedExecutions = this.failedExecutions.filter(e => e.id !== executionId);
                    
                    // Êõ¥Êñ∞‰ªªÂä°ÁªüËÆ°
                    if (this.selectedTask) {
                        this.selectedTask.failed_items = Math.max(0, this.selectedTask.failed_items - 1);
                    }
                    
                    // Âà∑Êñ∞‰ªªÂä°ÂàóË°®
                    await this.refreshTasks();
                    
                    this.showAlert('success', '‰ªªÂä°ÈáçËØïÊàêÂäü');
                } else {
                    this.showAlert('danger', data.detail || 'ÈáçËØïÂ§±Ë¥•');
                }
            } catch (error) {
                console.error('ÈáçËØïÂ§±Ë¥•:', error);
                this.showAlert('danger', 'ÈáçËØïÂ§±Ë¥•: ' + error.message);
            } finally {
                if (execution) {
                    execution.retrying = false;
                }
            }
        },

        // ÈáçËØïÊâÄÊúâÂ§±Ë¥•ÁöÑ‰ªªÂä°
        async retryAllFailedTasks(batchId) {
            this.retryingAll = true;
            try {
                const response = await fetch(`/api/batch/${batchId}/retry-failed`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (response.ok) {
                    // Ê∏ÖÁ©∫Â§±Ë¥•ÂàóË°®
                    this.failedExecutions = [];
                    
                    // Êõ¥Êñ∞‰ªªÂä°ÁªüËÆ°
                    if (this.selectedTask) {
                        this.selectedTask.failed_items = 0;
                    }
                    
                    // Âà∑Êñ∞‰ªªÂä°ÂàóË°®
                    await this.refreshTasks();
                    
                    this.showAlert('success', `ÊàêÂäüÈáçËØï ${data.retried_count} ‰∏™Â§±Ë¥•‰ªªÂä°`);
                } else {
                    this.showAlert('danger', data.detail || 'ÊâπÈáèÈáçËØïÂ§±Ë¥•');
                }
            } catch (error) {
                console.error('ÊâπÈáèÈáçËØïÂ§±Ë¥•:', error);
                this.showAlert('danger', 'ÊâπÈáèÈáçËØïÂ§±Ë¥•: ' + error.message);
            } finally {
                this.retryingAll = false;
            }
        },

        // ÈáçËØïÂ§±Ë¥•‰ªªÂä°Ôºà‰ªé‰ªªÂä°ÂàóË°®Ë∞ÉÁî®Ôºâ
        async retryFailedTasks(batchId) {
            try {
                const response = await fetch(`/api/batch/${batchId}/retry-failed`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (response.ok) {
                    this.showAlert('success', `ÊàêÂäüÈáçËØï ${data.retried_count} ‰∏™Â§±Ë¥•‰ªªÂä°`);
                    await this.refreshTasks();
                } else {
                    this.showAlert('danger', data.detail || 'ÈáçËØïÂ§±Ë¥•');
                }
            } catch (error) {
                console.error('ÈáçËØïÂ§±Ë¥•:', error);
                this.showAlert('danger', 'ÈáçËØïÂ§±Ë¥•: ' + error.message);
            }
        },

        // ÊòæÁ§∫ÊèêÁ§∫‰ø°ÊÅØ
        showAlert(type, message) {
            // ÂàõÂª∫ÊèêÁ§∫ÂÖÉÁ¥†
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // 3ÁßíÂêéËá™Âä®ÁßªÈô§
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 3000);
        },
        
        formatFileSize(bytes) {
            if (!bytes) return '';
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
        },
        
        getPageNumbers() {
            const pages = [];
            const total = this.pagination.pages;
            const current = this.pagination.page;
            
            if (total <= 7) {
                for (let i = 1; i <= total; i++) {
                    pages.push(i);
                }
            } else {
                if (current <= 4) {
                    for (let i = 1; i <= 5; i++) {
                        pages.push(i);
                    }
                    pages.push('...');
                    pages.push(total);
                } else if (current >= total - 3) {
                    pages.push(1);
                    pages.push('...');
                    for (let i = total - 4; i <= total; i++) {
                        pages.push(i);
                    }
                } else {
                    pages.push(1);
                    pages.push('...');
                    for (let i = current - 1; i <= current + 1; i++) {
                        pages.push(i);
                    }
                    pages.push('...');
                    pages.push(total);
                }
            }
            
            return pages;
        },
        
        showSuccessMessage(message) {
            // ÁÆÄÂçïÁöÑÊàêÂäüÊèêÁ§∫ÔºåÂèØ‰ª•Áî®Êõ¥Â•ΩÁöÑÈÄöÁü•ÁªÑ‰ª∂ÊõøÊç¢
            const alert = document.createElement('div');
            alert.className = 'alert alert-success alert-dismissible fade show position-fixed';
            alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alert.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alert);
            
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 5000);
        }
    }
}
</script>
{% endblock %} 