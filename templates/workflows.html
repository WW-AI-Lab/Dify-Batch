{% extends "base.html" %}

{% block title %}å·¥ä½œæµç®¡ç† - Dify Workflowæ‰¹é‡æ‰§è¡Œç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="row" x-data="workflowManager()">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <i class="fas fa-project-diagram me-2"></i>
                å·¥ä½œæµç®¡ç†
            </h2>
            <button class="btn btn-primary" @click="showWorkflowModal('add')">
                â• æ·»åŠ å·¥ä½œæµ
            </button>
        </div>
    </div>
    <!-- å·¥ä½œæµåˆ—è¡¨ -->
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>
                    å·¥ä½œæµåˆ—è¡¨
                </h5>
                <button class="btn btn-outline-primary btn-sm" @click="loadWorkflows()">
                    ğŸ”„ åˆ·æ–°
                </button>
            </div>
            <div class="card-body">
                <!-- åŠ è½½çŠ¶æ€ -->
                <div x-show="loading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">åŠ è½½ä¸­...</span>
                    </div>
                    <p class="mt-2">æ­£åœ¨åŠ è½½å·¥ä½œæµåˆ—è¡¨...</p>
                </div>
                
                <!-- é”™è¯¯çŠ¶æ€ -->
                <div x-show="!loading && error" class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span x-text="error"></span>
                </div>
                
                <!-- ç©ºçŠ¶æ€ -->
                <div x-show="!loading && !error && workflows.length === 0" class="text-center py-5">
                    <div style="font-size: 3rem;" class="text-muted mb-3">ğŸ“¦</div>
                    <h5 class="text-muted">æš‚æ— å·¥ä½œæµ</h5>
                    <p class="text-muted">ç‚¹å‡»"æ·»åŠ å·¥ä½œæµ"æŒ‰é’®åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªå·¥ä½œæµ</p>
                </div>
                
                <!-- å·¥ä½œæµåˆ—è¡¨ -->
                <div x-show="!loading && !error && workflows.length > 0">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <!-- <th>å·¥ä½œæµåç§°</th> -->
                                    <th>åº”ç”¨ä¿¡æ¯</th>
                                    <th>APIé…ç½®</th>
                                    <th>å‚æ•°æ•°é‡</th>
                                    <th>æœ€ååŒæ­¥</th>
                                    <th>çŠ¶æ€</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="workflow in workflows" :key="workflow.id">
                                    <tr>
                                        <!-- <td>
                                            <div>
                                                <strong x-text="workflow.name"></strong>
                                                <br>
                                                <small class="text-muted" x-text="workflow.description || 'æ— æè¿°'"></small>
                                            </div>
                                        </td> -->
                                        <td>
                                            <div x-show="workflow.app_name">
                                                <strong x-text="workflow.app_name"></strong>
                                                <br>
                                                <small class="text-muted" x-text="workflow.app_description || 'æ— æè¿°'"></small>
                                                <div x-show="workflow.app_tags && workflow.app_tags.length > 0" class="mt-1">
                                                    <template x-for="tag in workflow.app_tags" :key="tag">
                                                        <span class="badge bg-secondary me-1" x-text="tag"></span>
                                                    </template>
                                                </div>
                                            </div>
                                            <span x-show="!workflow.app_name" class="text-muted">æœªè·å–</span>
                                        </td>
                                        <td>
                                            <div>
                                                <small class="text-muted">URL:</small>
                                                <code x-text="workflow.base_url"></code>
                                                <br>
                                                <small class="text-muted">Key:</small>
                                                <code x-text="'***' + workflow.api_key.slice(-4)"></code>
                                            </div>
                                        </td>
                                        <td>
                                            <span x-show="workflow.parameters && workflow.parameters.parameters" 
                                                  class="badge bg-info" 
                                                  x-text="workflow.parameters.parameters.length + ' ä¸ªå‚æ•°'"></span>
                                            <span x-show="!workflow.parameters || !workflow.parameters.parameters" 
                                                  class="text-muted">æœªè·å–</span>
                                        </td>
                                        <td>
                                            <span x-show="workflow.last_sync_at" 
                                                  x-text="formatDate(workflow.last_sync_at)"></span>
                                            <span x-show="!workflow.last_sync_at" class="text-muted">ä»æœªåŒæ­¥</span>
                                        </td>
                                        <td>
                                            <span x-show="workflow.is_active" class="badge bg-success">æ¿€æ´»</span>
                                            <span x-show="!workflow.is_active" class="badge bg-secondary">ç¦ç”¨</span>
                                        </td>
                                        <td style="min-width: 220px;">
                                            <div class="d-flex flex-wrap gap-1">
                                                <button class="btn btn-info btn-sm text-white" 
                                                        @click="viewWorkflow(workflow)"
                                                        title="æŸ¥çœ‹å·¥ä½œæµè¯¦ç»†ä¿¡æ¯">
                                                    ğŸ‘ï¸ æŸ¥çœ‹è¯¦æƒ…
                                                </button>
                                                <button class="btn btn-success btn-sm" 
                                                        @click="syncWorkflow(workflow.id)"
                                                        title="åŒæ­¥æœ€æ–°çš„åº”ç”¨ä¿¡æ¯å’Œå‚æ•°">
                                                    ğŸ”„ åŒæ­¥ä¿¡æ¯
                                                </button>
                                                <button class="btn btn-warning btn-sm" 
                                                        @click="downloadTemplate(workflow)"
                                                        :disabled="!workflow.parameters"
                                                        title="ä¸‹è½½Excelæ‰¹é‡å¤„ç†æ¨¡æ¿">
                                                    ğŸ“¥ ä¸‹è½½æ¨¡æ¿
                                                </button>
                                                <div class="dropdown">
                                                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" 
                                                            type="button" 
                                                            :id="'dropdown-' + workflow.id"
                                                            data-bs-toggle="dropdown" 
                                                            aria-expanded="false"
                                                            title="æ›´å¤šæ“ä½œé€‰é¡¹">
                                                        âš™ï¸ æ›´å¤š
                                                    </button>
                                                    <ul class="dropdown-menu" :aria-labelledby="'dropdown-' + workflow.id">
                                                        <li>
                                                            <a class="dropdown-item" href="#" @click.prevent="showWorkflowModal('edit', workflow)">
                                                                âœï¸ ç¼–è¾‘å·¥ä½œæµ
                                                            </a>
                                                        </li>
                                                        <li><hr class="dropdown-divider"></li>
                                                        <li>
                                                            <a class="dropdown-item text-danger" href="#" @click.prevent="deleteWorkflow(workflow.id)">
                                                                ğŸ—‘ï¸ åˆ é™¤å·¥ä½œæµ
                                                            </a>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å·¥ä½œæµæ¨¡æ€æ¡†ï¼ˆæ·»åŠ /ç¼–è¾‘å¤ç”¨ï¼‰ -->
    <div class="modal fade" :class="{'show d-block': showModal}" style="background-color: rgba(0,0,0,0.5);" x-show="showModal">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <span x-show="modalMode === 'add'">â• æ·»åŠ æ–°å·¥ä½œæµ</span>
                        <span x-show="modalMode === 'edit'">âœï¸ ç¼–è¾‘å·¥ä½œæµ</span>
                    </h5>
                    <button type="button" class="btn-close" @click="closeWorkflowModal()" title="å…³é—­"></button>
                </div>
                <div class="modal-body">
                    <form @submit.prevent="saveWorkflow()">
                        <div class="mb-3">
                            <label for="workflowName" class="form-label">å·¥ä½œæµåç§° *</label>
                            <input type="text" class="form-control" id="workflowName" 
                                   x-model="workflowForm.name" required>
                        </div>
                        <div class="mb-3">
                            <label for="workflowDescription" class="form-label">æè¿°</label>
                            <textarea class="form-control" id="workflowDescription" rows="3"
                                      x-model="workflowForm.description"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="baseUrl" class="form-label">Dify API Base URL *</label>
                            <input type="url" class="form-control" id="baseUrl" 
                                   x-model="workflowForm.base_url" 
                                   placeholder="https://api.dify.ai/v1" required>
                            <div class="form-text">ä¾‹å¦‚: https://api.dify.ai/v1</div>
                        </div>
                        <div class="mb-3">
                            <label for="apiKey" class="form-label">API Key *</label>
                            <input type="password" class="form-control" id="apiKey" 
                                   x-model="workflowForm.api_key" required>
                            <div class="form-text">æ‚¨çš„Difyåº”ç”¨APIå¯†é’¥</div>
                        </div>
                        
                        <!-- å¤„ç†çŠ¶æ€ -->
                        <div x-show="processing" class="alert alert-info">
                            <span x-show="modalMode === 'add'">â³ æ­£åœ¨éªŒè¯APIé…ç½®å¹¶åˆ›å»ºå·¥ä½œæµ...</span>
                            <span x-show="modalMode === 'edit'">â³ æ­£åœ¨ä¿å­˜å·¥ä½œæµ...</span>
                        </div>
                        
                        <div x-show="formError" class="alert alert-danger">
                            âŒ <span x-text="formError"></span>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @click="closeWorkflowModal()">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" 
                            @click="saveWorkflow()" 
                            :disabled="processing || !workflowForm.name || !workflowForm.base_url || !workflowForm.api_key">
                        <span x-show="processing && modalMode === 'add'">â³ åˆ›å»ºä¸­...</span>
                        <span x-show="processing && modalMode === 'edit'">â³ ä¿å­˜ä¸­...</span>
                        <span x-show="!processing && modalMode === 'add'">â• æ·»åŠ å·¥ä½œæµ</span>
                        <span x-show="!processing && modalMode === 'edit'">ğŸ’¾ ä¿å­˜æ›´æ”¹</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æŸ¥çœ‹å·¥ä½œæµè¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="modal fade" :class="{'show d-block': showViewModal}" style="background-color: rgba(0,0,0,0.5);" x-show="showViewModal">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-eye me-2"></i>
                        å·¥ä½œæµè¯¦æƒ…
                    </h5>
                    <button type="button" class="btn-close" @click="showViewModal = false" title="å…³é—­"></button>
                </div>
                <div class="modal-body" x-show="currentWorkflow">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>åŸºæœ¬ä¿¡æ¯</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>åç§°:</strong></td>
                                    <td x-text="currentWorkflow?.name"></td>
                                </tr>
                                <tr>
                                    <td><strong>æè¿°:</strong></td>
                                    <td x-text="currentWorkflow?.description || 'æ— '"></td>
                                </tr>
                                <tr>
                                    <td><strong>åˆ›å»ºæ—¶é—´:</strong></td>
                                    <td x-text="formatDate(currentWorkflow?.created_at)"></td>
                                </tr>
                                <tr>
                                    <td><strong>æ›´æ–°æ—¶é—´:</strong></td>
                                    <td x-text="formatDate(currentWorkflow?.updated_at)"></td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>åº”ç”¨ä¿¡æ¯</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>åº”ç”¨åç§°:</strong></td>
                                    <td x-text="currentWorkflow?.app_name || 'æœªè·å–'"></td>
                                </tr>
                                <tr>
                                    <td><strong>åº”ç”¨æè¿°:</strong></td>
                                    <td x-text="currentWorkflow?.app_description || 'æ— '"></td>
                                </tr>
                                <tr>
                                    <td><strong>æ ‡ç­¾:</strong></td>
                                    <td>
                                        <template x-for="tag in currentWorkflow?.app_tags || []" :key="tag">
                                            <span class="badge bg-secondary me-1" x-text="tag"></span>
                                        </template>
                                        <span x-show="!currentWorkflow?.app_tags || currentWorkflow.app_tags.length === 0" class="text-muted">æ— </span>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    <div x-show="currentWorkflow?.parameters && currentWorkflow.parameters.parameters">
                        <h6>å‚æ•°åˆ—è¡¨</h6>
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead>
                                    <tr>
                                        <th>å‚æ•°åç§°</th>
                                        <th>ç±»å‹</th>
                                        <th>å¿…éœ€</th>
                                        <th>æè¿°</th>
                                        <th>é»˜è®¤å€¼</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="param in currentWorkflow?.parameters?.parameters || []" :key="param.name">
                                        <tr>
                                            <td><code x-text="param.name"></code></td>
                                            <td><span class="badge bg-secondary" x-text="param.type"></span></td>
                                            <td>
                                                <span x-show="param.required" class="badge bg-danger">å¿…éœ€</span>
                                                <span x-show="!param.required" class="badge bg-success">å¯é€‰</span>
                                            </td>
                                            <td x-text="param.description || '-'"></td>
                                            <td><code x-text="param.default_value || '-'"></code></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @click="showViewModal = false">å…³é—­</button>
                    <button type="button" class="btn btn-success" 
                            @click="downloadTemplate(currentWorkflow)"
                            :disabled="!currentWorkflow?.parameters">
                        ğŸ“¥ ä¸‹è½½Excelæ¨¡æ¿
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function workflowManager() {
    return {
        // çŠ¶æ€
        loading: true,
        error: null,
        workflows: [],
        
        // ç³»ç»Ÿé…ç½®
        systemConfig: {
            dify_base_url: 'https://api.dify.ai/v1',
            app_name: '',
            app_version: ''
        },
        
        // æ¨¡æ€æ¡†çŠ¶æ€
        showModal: false,
        showViewModal: false,
        modalMode: 'add', // 'add' æˆ– 'edit'
        currentWorkflow: null,
        
        // ç»Ÿä¸€çš„å·¥ä½œæµè¡¨å•
        workflowForm: {
            id: '',
            name: '',
            description: '',
            base_url: '',
            api_key: ''
        },
        
        // å¤„ç†çŠ¶æ€
        processing: false,
        formError: null,
        
        async init() {
            await this.loadSystemConfig();
            await this.loadWorkflows();
        },
        
        async loadSystemConfig() {
            try {
                const response = await fetch('/api/config/');
                if (response.ok) {
                    this.systemConfig = await response.json();
                }
            } catch (error) {
                console.error('åŠ è½½ç³»ç»Ÿé…ç½®å¤±è´¥:', error);
            }
        },
        
        async loadWorkflows() {
            this.loading = true;
            this.error = null;
            
            try {
                const response = await fetch('/api/workflows/');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                this.workflows = await response.json();
            } catch (error) {
                this.error = `è·å–å·¥ä½œæµåˆ—è¡¨å¤±è´¥: ${error.message}`;
                console.error('Error loading workflows:', error);
            } finally {
                this.loading = false;
            }
        },
        
        showWorkflowModal(mode, workflow = null) {
            this.modalMode = mode;
            this.formError = null;
            
            if (mode === 'add') {
                // æ·»åŠ æ¨¡å¼ï¼šä½¿ç”¨ç³»ç»Ÿé…ç½®çš„é»˜è®¤base URL
                this.workflowForm = {
                    id: '',
                    name: '',
                    description: '',
                    base_url: this.systemConfig.dify_base_url,
                    api_key: ''
                };
            } else if (mode === 'edit' && workflow) {
                // ç¼–è¾‘æ¨¡å¼ï¼šå¡«å……ç°æœ‰æ•°æ®
                this.workflowForm = {
                    id: workflow.id,
                    name: workflow.name,
                    description: workflow.description || '',
                    base_url: workflow.base_url,
                    api_key: workflow.api_key
                };
            }
            
            this.showModal = true;
        },
        
        async saveWorkflow() {
            this.processing = true;
            this.formError = null;
            
            try {
                let response;
                if (this.modalMode === 'add') {
                    // åˆ›å»ºæ–°å·¥ä½œæµ
                    response = await fetch('/api/workflows/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: this.workflowForm.name,
                            description: this.workflowForm.description,
                            base_url: this.workflowForm.base_url,
                            api_key: this.workflowForm.api_key
                        })
                    });
                } else {
                    // æ›´æ–°ç°æœ‰å·¥ä½œæµ
                    response = await fetch(`/api/workflows/${this.workflowForm.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: this.workflowForm.name,
                            description: this.workflowForm.description,
                            base_url: this.workflowForm.base_url,
                            api_key: this.workflowForm.api_key
                        })
                    });
                }
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP ${response.status}`);
                }
                
                const workflow = await response.json();
                
                if (this.modalMode === 'add') {
                    // æ·»åŠ åˆ°åˆ—è¡¨å¼€å¤´
                    this.workflows.unshift(workflow);
                    this.showSuccessMessage('å·¥ä½œæµåˆ›å»ºæˆåŠŸï¼');
                } else {
                    // æ›´æ–°åˆ—è¡¨ä¸­çš„å·¥ä½œæµ
                    const index = this.workflows.findIndex(w => w.id === this.workflowForm.id);
                    if (index !== -1) {
                        this.workflows[index] = workflow;
                    }
                    this.showSuccessMessage('å·¥ä½œæµæ›´æ–°æˆåŠŸï¼');
                }
                
                this.closeWorkflowModal();
                
            } catch (error) {
                this.formError = error.message;
                console.error('Error saving workflow:', error);
            } finally {
                this.processing = false;
            }
        },
        
        closeWorkflowModal() {
            this.showModal = false;
            this.workflowForm = {
                id: '',
                name: '',
                description: '',
                base_url: this.systemConfig.dify_base_url,
                api_key: ''
            };
            this.formError = null;
        },
        
        async syncWorkflow(workflowId) {
            try {
                const response = await fetch(`/api/workflows/${workflowId}/sync`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP ${response.status}`);
                }
                
                const updatedWorkflow = await response.json();
                
                // æ›´æ–°åˆ—è¡¨ä¸­çš„å·¥ä½œæµ
                const index = this.workflows.findIndex(w => w.id === workflowId);
                if (index !== -1) {
                    this.workflows[index] = updatedWorkflow;
                }
                
                this.showSuccessMessage('å·¥ä½œæµä¿¡æ¯åŒæ­¥æˆåŠŸï¼');
                
            } catch (error) {
                alert(`åŒæ­¥å·¥ä½œæµå¤±è´¥: ${error.message}`);
            }
        },
        
        async deleteWorkflow(workflowId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå·¥ä½œæµå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/workflows/${workflowId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP ${response.status}`);
                }
                
                // ä»åˆ—è¡¨ä¸­ç§»é™¤
                this.workflows = this.workflows.filter(w => w.id !== workflowId);
                this.showSuccessMessage('å·¥ä½œæµåˆ é™¤æˆåŠŸï¼');
                
            } catch (error) {
                alert(`åˆ é™¤å·¥ä½œæµå¤±è´¥: ${error.message}`);
            }
        },
        
        viewWorkflow(workflow) {
            this.currentWorkflow = workflow;
            this.showViewModal = true;
        },
        

        
        async downloadTemplate(workflow) {
            if (!workflow.parameters) {
                alert('è¯¥å·¥ä½œæµæš‚æ— å‚æ•°ä¿¡æ¯ï¼Œè¯·å…ˆåŒæ­¥');
                return;
            }
            
            try {
                const response = await fetch(`/api/workflows/${workflow.id}/template`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${workflow.name}_template.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                alert(`ä¸‹è½½æ¨¡æ¿å¤±è´¥: ${error.message}`);
            }
        },
        

        
        formatDate(dateString) {
            if (!dateString) return '-';
            return new Date(dateString).toLocaleString('zh-CN');
        },
        
        showSuccessMessage(message) {
            // ç®€å•çš„æˆåŠŸæç¤ºï¼Œå¯ä»¥åç»­æ”¹ä¸ºæ›´å¥½çš„UIç»„ä»¶
            const alert = document.createElement('div');
            alert.className = 'alert alert-success alert-dismissible fade show position-fixed';
            alert.style.top = '20px';
            alert.style.right = '20px';
            alert.style.zIndex = '9999';
            alert.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alert);
            
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 3000);
        }
    }
}
</script>
{% endblock %} 