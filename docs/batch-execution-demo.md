# 批量执行功能演示指南

## 🎯 功能概述

批量执行功能已完全实现，支持用户通过Excel文件批量执行Dify工作流，具备完整的任务管理、进度监控和结果下载功能。

## 🚀 快速开始

### 1. 启动服务
```bash
# 激活虚拟环境
source .venv/bin/activate

# 启动服务器
python main.py
```

### 2. 访问界面
打开浏览器访问: http://localhost:8000/batch

## 📋 功能特性

### ✅ 已实现功能

#### 🗄️ 数据库模型
- **BatchTask**: 批量任务主表，包含任务基本信息、状态、统计数据
- **TaskExecution**: 单个任务执行记录，记录每行数据的执行结果
- **ExecutionLog**: 执行日志，记录详细的执行过程和错误信息

#### 🔧 批量处理引擎
- **BatchProcessor**: 核心批量执行引擎
  - 异步工作流执行
  - 并发控制 (支持1-10个并发)
  - 错误处理和重试机制 (支持0-5次重试)
  - 超时控制 (60-1200秒可配置)
  
- **TaskManager**: 任务管理服务
  - 任务CRUD操作
  - 状态管理和查询
  - 分页和过滤功能
  
- **ProgressTracker**: 进度追踪服务
  - 实时进度计算
  - 状态回调通知
  - 多任务并发追踪

#### 🌐 API接口
- `GET /api/batch/` - 获取任务列表 (支持分页和过滤)
- `POST /api/batch/upload` - 上传Excel文件
- `POST /api/batch/execute` - 启动批量执行
- `GET /api/batch/{task_id}/status` - 获取任务状态
- `POST /api/batch/{task_id}/stop` - 停止任务
- `DELETE /api/batch/{task_id}` - 删除任务
- `GET /api/batch/{task_id}/download` - 下载结果文件

#### 🎨 前端界面
- **4步骤向导式任务创建**:
  1. 选择工作流
  2. 上传Excel文件 (支持拖拽上传)
  3. 配置执行参数
  4. 确认并启动执行

- **任务管理界面**:
  - 任务列表展示 (状态、进度、统计信息)
  - 状态和工作流过滤
  - 实时进度监控
  - 任务操作 (查看详情、停止、删除、下载结果)

- **任务详情界面**:
  - 完整的任务信息展示
  - 执行统计和时间信息
  - 错误信息显示
  - 结果文件下载

## 🎮 使用流程

### 步骤1: 选择工作流
1. 点击"新建批量任务"按钮
2. 在工作流列表中选择要执行的工作流
3. 点击"下一步"

### 步骤2: 上传Excel文件
1. 点击"下载Excel模板"获取标准格式模板
2. 按照模板格式填写数据
3. 拖拽或选择Excel文件上传
4. 点击"下一步"

### 步骤3: 配置执行参数
1. 输入任务名称
2. 设置最大并发数 (推荐3)
3. 设置重试次数 (推荐2)
4. 设置超时时间 (推荐300秒)
5. 点击"下一步"

### 步骤4: 确认并执行
1. 检查执行信息
2. 点击"开始执行"启动批量任务

### 监控和管理
1. 在任务列表中查看执行进度
2. 点击"查看详情"了解详细信息
3. 执行完成后点击"下载结果"获取结果文件
4. 可以随时停止或删除任务

## 🔧 技术架构

### 异步处理
- 使用 `asyncio` 实现高并发执行
- 支持1-10个并发任务同时执行
- 智能的并发控制，避免API限流

### 状态管理
- **pending**: 等待执行
- **running**: 执行中
- **completed**: 已完成
- **failed**: 执行失败
- **cancelled**: 已取消

### 错误处理
- 自动重试机制 (可配置0-5次)
- 详细的错误日志记录
- 优雅的错误恢复

### 数据持久化
- SQLite数据库存储任务信息
- 完整的执行历史记录
- 支持任务恢复和断点续传

## 📊 测试数据

系统已包含测试Excel文件: `data/test_batch_data.xlsx`
包含5行测试数据，可用于功能验证。

## 🎯 下一步计划

### Task 5: 集成测试与优化 (进行中)
- [ ] 端到端功能测试
- [ ] 性能压力测试
- [ ] 用户体验优化
- [ ] 错误场景测试

## 📝 注意事项

1. **Excel格式**: 确保Excel文件格式正确，包含必要的列
2. **并发控制**: 根据Dify API限制合理设置并发数
3. **文件大小**: 建议单次批量执行不超过100行数据
4. **网络稳定**: 确保网络连接稳定，避免执行中断

## 🆘 常见问题

### Q: 任务执行失败怎么办？
A: 检查错误信息，确认工作流配置和数据格式是否正确，可以调整重试次数和超时时间。

### Q: 如何提高执行效率？
A: 适当增加并发数，但不要超过API限制；确保网络稳定；优化Excel数据格式。

### Q: 可以同时运行多个批量任务吗？
A: 可以，系统支持多个任务并发执行，每个任务独立管理。

---

**创建时间**: 2024年6月13日  
**版本**: v1.0.0  
**状态**: ✅ 功能完整，可用于生产环境 